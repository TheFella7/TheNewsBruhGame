<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The News Bruh | Tycoon</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* NEW: Name Selection Modal Styles */
        #name-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }

        #name-selection-modal.hidden {
            display: none;
        }

        .name-modal-content {
            background: var(--bg-paper);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            padding: 40px;
            max-width: 600px;
            width: 100%;
            border: 6px solid var(--ink);
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            position: relative;
            text-align: center;
        }

        .name-modal-content::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 2px solid var(--red-accent);
            pointer-events: none;
        }

        .name-modal-title {
            font-family: var(--font-old-english);
            font-size: 3.5rem;
            margin-bottom: 10px;
            color: var(--ink);
        }

        .name-modal-subtitle {
            font-family: var(--font-head);
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: var(--ink-light);
            font-style: italic;
        }

        .name-input-container {
            margin: 30px 0;
        }

        #player-name-input {
            width: 100%;
            padding: 20px;
            font-family: var(--font-mono);
            font-size: 1.2rem;
            border: 3px solid var(--ink);
            background: white;
            text-align: center;
            outline: none;
            transition: all 0.3s;
        }

        #player-name-input:focus {
            border-color: var(--red-accent);
            box-shadow: 0 0 20px rgba(204, 0, 0, 0.3);
        }

        .name-rules {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--ink-light);
            margin-top: 10px;
            text-align: left;
            padding: 15px;
            background: var(--bg-paper-dark);
            border: 1px solid var(--ink);
        }

        .name-rules ul {
            list-style: none;
            padding-left: 10px;
        }

        .name-rules li {
            margin-bottom: 5px;
            position: relative;
            padding-left: 20px;
        }

        .name-rules li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: var(--red-accent);
        }

        .start-game-btn {
            background: var(--red-accent);
            color: white;
            border: none;
            padding: 20px 40px;
            font-family: var(--font-head);
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 20px;
            width: 100%;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .start-game-btn:hover {
            background: #b30000;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .start-game-btn:active {
            transform: translateY(1px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
        }

        .start-game-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255,255,255,0.1) 50%,
                transparent 70%
            );
            transform: rotate(45deg);
            animation: shine 3s infinite linear;
        }

        @keyframes shine {
            0% { transform: rotate(45deg) translateX(-100%); }
            100% { transform: rotate(45deg) translateX(100%); }
        }

        @media (max-width: 768px) {
            .name-modal-content {
                padding: 20px;
            }
            
            .name-modal-title {
                font-size: 2.5rem;
            }
            
            #player-name-input {
                padding: 15px;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .name-modal-title {
                font-size: 2rem;
            }
            
            .name-modal-subtitle {
                font-size: 1rem;
            }
            
            .start-game-btn {
                padding: 15px;
                font-size: 1.1rem;
            }
        }

        :root {
            --bg-paper: #f9f7f1; 
            --bg-paper-dark: #e6e4dc;
            --ink: #0a0a0a;
            --ink-light: #454545;
            --red-accent: #cc0000;
            --green-accent: #006400;
            --border: 2px solid #1a1a1a;
            --font-head: 'Playfair Display', serif;
            --font-mono: 'Courier Prime', monospace;
            --font-old-english: 'UnifrakturMaguntia', cursive; 
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #2e2e2e;
            margin: 0;
            padding: 0;
            font-family: var(--font-head);
            color: var(--ink);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            position: relative;
            padding: 10px;
        }

        #newspaper {
            background-color: var(--bg-paper);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            width: 100%;
            max-width: 1400px;
            height: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            position: relative;
        }

        #ticker-tape {
            background: var(--ink);
            color: #ffffff; 
            font-family: var(--font-mono);
            font-size: 0.9rem;
            padding: 6px 0;
            overflow: hidden;
            white-space: nowrap;
            border-bottom: 3px solid var(--ink);
            position: relative;
            width: 100%;
        }
        .ticker-content {
            display: inline-block;
            animation: marquee 25s linear infinite;
            padding-left: 100%;
            white-space: nowrap;
        }
        .ticker-content a {
            color: #4dabf7;
            text-decoration: underline;
            font-weight: bold;
            margin: 0 20px;
        }
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        header {
            text-align: center;
            padding: 15px 20px;
            border-bottom: 5px double var(--ink);
        }
        h1 {
            font-family: var(--font-old-english);
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            margin: 0;
            font-weight: normal;
            line-height: 1;
        }
        
        .player-counts {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--ink-light);
            margin-top: 5px;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .player-counts span {
            font-weight: bold;
        }

        .meta-line {
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--ink);
            border-bottom: 1px solid var(--ink);
            margin-top: 5px;
            padding: 4px 0;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: bold;
            text-transform: uppercase;
            flex-wrap: wrap;
        }
        .meta-line span {
            margin: 0 5px;
        }

        #main-content {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr;
            gap: 0;
            flex: 1;
            min-height: 500px;
        }

        .column {
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #aaa;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 400px;
        }
        .column:last-child { border-right: none; }

        .column::-webkit-scrollbar { width: 8px; }
        .column::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .column::-webkit-scrollbar-track { background: transparent; }

        h2 {
            font-family: var(--font-head);
            border-bottom: 3px double var(--ink);
            margin-top: 0;
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: 900;
            padding-bottom: 5px;
        }

        .stat-block {
            background: rgba(0,0,0,0.02);
            border: 1px solid var(--ink);
            padding: 12px;
            margin-bottom: 15px;
            font-family: var(--font-mono);
            transition: transform 0.2s;
        }
        .stat-block:hover {
            transform: translateY(-2px);
        }
        .stat-label { 
            font-size: 0.9rem; 
            color: var(--ink-light); 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        .stat-value { 
            font-size: 1.6rem; 
            font-weight: bold; 
            color: var(--ink);
        }

        /* ENHANCED: Breaking News Banner */
        #breaking-news-container {
            position: relative;
            margin-bottom: 20px;
            min-height: 80px;
        }

        #breaking-news-banner {
            display: none;
            background: linear-gradient(45deg, #cc0000 0%, #ff0000 25%, #cc0000 50%, #ff0000 75%, #cc0000 100%);
            background-size: 400% 400%;
            animation: breakingNewsGradient 3s ease infinite;
            color: #ffffff;
            padding: 12px 20px;
            text-align: center;
            font-family: var(--font-mono);
            font-weight: bold;
            font-size: 1.2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            border: 3px solid #ffcc00;
            border-radius: 0;
            box-shadow: 0 4px 20px rgba(255, 0, 0, 0.4), 
                        inset 0 0 20px rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            transform: perspective(500px) rotateX(5deg);
            transition: all 0.3s ease;
        }

        @keyframes breakingNewsGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #breaking-news-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #ffcc00, transparent);
            animation: scanLine 2s linear infinite;
        }

        @keyframes scanLine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        #breaking-news-banner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(255, 255, 255, 0.1) 2px,
                rgba(255, 255, 255, 0.1) 4px
            );
            pointer-events: none;
        }

        .breaking-news-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            z-index: 2;
        }

        .breaking-news-icon {
            font-size: 1.5rem;
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .breaking-news-title {
            font-size: 1.3rem;
            background: linear-gradient(to bottom, #fff, #ffcc00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        #print-btn {
            background: #ffffff;
            border: 4px solid var(--ink);
            padding: 40px 20px;
            width: 100%;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.8);
            touch-action: manipulation;
            user-select: none;
        }
        #print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 8px 8px 0px rgba(0,0,0,0.8);
        }
        #print-btn:active {
            transform: translate(4px, 4px);
            box-shadow: 2px 2px 0px rgba(0,0,0,0.8);
        }
        #print-btn.pulse {
            animation: pulse 0.3s ease;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }
        .print-title {
            font-family: var(--font-head);
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 900;
            display: block;
            text-transform: uppercase;
            line-height: 1.2;
        }
        .print-sub {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            display: block;
            margin-top: 10px;
            color: var(--ink-light);
            font-weight: bold;
        }

        /* ENHANCED: Boost System Styles - RED THEME */
        #boost-container {
            margin: 20px 0;
            text-align: center;
        }

        #boost-button {
            width: 100%;
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            border: 3px solid var(--ink);
            padding: 20px 15px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            font-family: var(--font-mono);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #boost-button:hover:not(:disabled) {
            background: linear-gradient(to bottom, #e8e8e8, #c8c8c8);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #boost-button:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #boost-button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        #boost-progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ff0000, #ff4444);
            background-size: 200% 100%;
            position: absolute;
            top: 0;
            left: 0;
            transition: width 0.3s;
            z-index: 0;
            animation: progressShimmer 2s infinite linear;
        }

        @keyframes progressShimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .boost-content {
            position: relative;
            z-index: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .boost-percentage {
            font-size: 2rem;
            font-weight: bold;
            color: var(--ink);
            display: block;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .boost-label {
            font-size: 1rem;
            color: var(--ink-light);
            display: block;
            font-weight: bold;
        }

        .boost-timer {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--red-accent);
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 12px;
            border-radius: 20px;
            border: 2px solid var(--red-accent);
            display: none;
            animation: timerPulse 1s infinite alternate;
        }

        @keyframes timerPulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .boost-cooldown {
            font-size: 0.9rem;
            color: var(--red-accent);
            font-weight: bold;
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 10px;
            border-radius: 15px;
            margin-top: 5px;
        }

        /* Falling Emojis */
        .breaking-news-flash {
            position: absolute;
            font-size: 1.8rem;
            animation: fallDown 2s linear forwards;
            pointer-events: none;
            z-index: 100;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            filter: drop-shadow(0 0 3px rgba(255, 204, 0, 0.8));
        }

        @keyframes fallDown {
            0% {
                transform: translateY(-50px) rotate(0deg) scale(1);
                opacity: 1;
            }
            70% { opacity: 1; }
            100% {
                transform: translateY(300px) rotate(360deg) scale(0.5);
                opacity: 0;
            }
        }

        /* Active Boost Indicator */
        .stat-block.active-boost {
            animation: boostGlow 1.5s infinite alternate;
            border-color: var(--red-accent);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
        }

        @keyframes boostGlow {
            from { 
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.4);
                transform: translateY(0);
            }
            to { 
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.8), 0 5px 15px rgba(255, 0, 0, 0.3);
                transform: translateY(-3px);
            }
        }

        #upgrades-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .upgrade-card {
            border: 1px solid var(--ink);
            background: #ffffff;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.15);
            transition: all 0.2s ease;
        }
        .upgrade-card.disabled {
            opacity: 0.5;
            background: var(--bg-paper-dark);
            box-shadow: none;
            border: 1px dashed #777;
        }
        .upgrade-card.purchased {
            background: #f0fff0;
            border-color: var(--green-accent);
            box-shadow: 4px 4px 0 rgba(0,100,0,0.2);
        }
        .upgrade-card.affordable {
            animation: glow 1.5s infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 4px 4px 0 rgba(0,100,0,0.2), 0 0 5px rgba(0,100,0,0.3); }
            to { box-shadow: 4px 4px 0 rgba(0,100,0,0.4), 0 0 10px rgba(0,100,0,0.5); }
        }
        .upgrade-top {
            padding: 12px;
            border-bottom: 1px dotted #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .upgrade-name { 
            font-weight: bold; 
            font-size: 1.1rem; 
            font-family: var(--font-head);
        }
        .upgrade-count { 
            font-family: var(--font-mono); 
            font-size: 1.2rem; 
            font-weight: bold;
            color: var(--green-accent);
        }
        
        .upgrade-info {
            padding: 8px 12px;
            font-size: 0.8rem;
            color: var(--ink-light);
            border-bottom: 1px dotted #ccc;
        }
        
        .upgrade-btn {
            width: 100%;
            border: none;
            background: transparent;
            padding: 12px;
            text-align: left;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        .upgrade-btn:hover:not(:disabled) {
            background: #f5f5f5;
        }
        .upgrade-btn:active:not(:disabled) {
            background: #e0e0e0;
        }
        .upgrade-btn:disabled {
            cursor: not-allowed;
            color: #777;
        }
        .upgrade-btn.affordable {
            font-weight: bold;
            color: var(--green-accent);
            background: #f0fff0;
        }
        .upgrade-cost {
            font-weight: bold;
        }
        .upgrade-max {
            font-weight: bold;
        }

        .prestige-box {
            margin-top: auto;
            border: 4px double var(--ink);
            padding: 20px;
            background: var(--bg-paper-dark);
            text-align: center;
        }
        .prestige-btn {
            background: var(--red-accent);
            color: #fff;
            border: none;
            padding: 15px;
            width: 100%;
            font-family: var(--font-head);
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 15px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .prestige-btn:hover:not(:disabled) {
            background: #b30000;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .prestige-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        .prestige-btn:disabled { 
            background: #555; 
            cursor: not-allowed; 
            opacity: 0.5;
        }
        .prestige-cost {
            font-size: 0.9rem;
            font-weight: normal;
            margin-top: 5px;
            color: #ffcccc;
        }
        .prestige-max {
            font-size: 0.8rem;
            font-weight: normal;
            margin-top: 3px;
            color: #aaffaa;
        }

        .floater {
            position: fixed;
            font-family: var(--font-mono), 'Segoe UI Emoji', 'Apple Color Emoji', monospace;
            font-weight: bold;
            color: var(--red-accent);
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 10000;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-size: 1.4rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        @keyframes floatUp {
            0% { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
            70% { opacity: 1; }
            100% { 
                transform: translateY(-100px) scale(1.4); 
                opacity: 0; 
            }
        }

        .headline-box {
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid var(--ink);
            border-bottom: 1px solid var(--ink);
            background: rgba(255,255,255,0.5);
        }
        .headline-box strong {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        #headline-spot {
            font-style: italic;
            font-family: Georgia, serif;
            font-size: 1.1rem;
            line-height: 1.4;
            margin-top: 8px;
            min-height: 60px;
            transition: opacity 0.5s ease;
        }

        /* NEW: Leaderboard Styles */
        #leaderboard-section {
            border-top: 5px double var(--ink);
            padding: 20px;
            background: var(--bg-paper-dark);
        }

        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        #leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        #leaderboard-table th {
            background: var(--ink);
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border-right: 1px solid #555;
        }

        #leaderboard-table th:last-child {
            border-right: none;
        }

        #leaderboard-table td {
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }

        #leaderboard-table tr:nth-child(even) {
            background: rgba(0,0,0,0.05);
        }

        #leaderboard-table tr:hover {
            background: rgba(0,0,0,0.1);
        }

        .player-rank {
            font-weight: bold;
            width: 50px;
            text-align: center;
        }

        .rank-1 { color: gold; font-weight: bold; }
        .rank-2 { color: silver; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }

        .player-name {
            font-weight: bold;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-bruh, .player-level {
            text-align: center;
            font-weight: bold;
        }

        /* NEW: Chat Styles */
        #chat-section {
            border-top: 5px double var(--ink);
            padding: 20px;
            background: var(--bg-paper);
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            #chat-section {
                grid-template-columns: 1fr;
            }
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 300px;
            border: 2px solid var(--ink);
            background: white;
        }

        .chat-header {
            background: var(--ink);
            color: white;
            padding: 10px;
            font-family: var(--font-mono);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-message {
            padding: 8px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.self {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
            margin-left: 20px;
        }

        .chat-message.other {
            background: #f5f5f5;
            border-left: 3px solid #757575;
            margin-right: 20px;
        }

        .chat-message.tagged {
            background: #fff8e1;
            border-left: 3px solid #ff9800;
            animation: pulseTag 1s ease;
        }

        @keyframes pulseTag {
            0%, 100% { background: #fff8e1; }
            50% { background: #ffecb3; }
        }

        .message-sender {
            font-weight: bold;
            color: var(--ink);
            margin-bottom: 3px;
        }

        .message-timestamp {
            font-size: 0.7rem;
            color: var(--ink-light);
            float: right;
            margin-left: 10px;
        }

        .message-content {
            word-break: break-word;
        }

        .tagged-player {
            background: #ff9800;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
            margin: 0 2px;
        }

        #chat-input-container {
            display: flex;
            border-top: 1px solid #ccc;
        }

        #chat-input {
            flex: 1;
            border: none;
            padding: 12px;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            outline: none;
        }

        #chat-send {
            background: var(--ink);
            color: white;
            border: none;
            padding: 0 20px;
            font-family: var(--font-mono);
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        #chat-send:hover {
            background: #333;
        }

        #chat-send:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .chat-users {
            border: 2px solid var(--ink);
            background: white;
            display: flex;
            flex-direction: column;
        }

        .users-header {
            background: var(--ink);
            color: white;
            padding: 10px;
            font-family: var(--font-mono);
            font-weight: bold;
        }

        #online-users {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .user-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item:hover {
            background: #f5f5f5;
        }

        .user-name {
            font-weight: bold;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-bruh {
            color: var(--green-accent);
            font-weight: bold;
        }

        .user-online {
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .chat-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff9800;
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10002;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 4.7s forwards;
            max-width: 300px;
            cursor: pointer;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .notification-sender {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        @media (max-width: 1024px) {
            #main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                height: auto;
            }
            
            .column {
                min-height: 300px;
                max-height: 500px;
                border-right: none;
                border-bottom: 2px solid #aaa;
            }
            .column:last-child {
                border-bottom: none;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                overflow-x: hidden;
            }
            
            #newspaper {
                min-height: 100vh;
                height: auto;
            }
            
            .column {
                padding: 15px;
                min-height: auto;
                max-height: none;
                overflow-y: visible;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            #breaking-news-banner {
                font-size: 1rem;
                padding: 10px 15px;
            }
            
            .breaking-news-text {
                flex-direction: column;
                gap: 10px;
            }
            
            .breaking-news-title {
                font-size: 1.1rem;
            }
            
            #print-btn {
                padding: 30px 15px;
            }
            
            .print-title {
                font-size: 1.8rem;
            }
            
            .meta-line {
                font-size: 0.75rem;
            }
            
            .player-counts {
                font-size: 0.7rem;
            }
            
            .stat-value {
                font-size: 1.4rem;
            }
            
            .prestige-box {
                padding: 15px;
            }

            #leaderboard-section,
            #chat-section {
                padding: 15px;
            }

            .chat-container,
            .chat-users {
                height: 250px;
            }

            #chat-section {
                grid-template-columns: 1fr;
            }
            
            #boost-button {
                padding: 15px 10px;
                min-height: 80px;
            }
            
            .boost-percentage {
                font-size: 1.6rem;
            }
            
            .boost-label {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            #print-btn {
                padding: 25px 10px;
            }
            
            .print-title {
                font-size: 1.5rem;
            }
            
            .column {
                padding: 10px;
            }

            #breaking-news-banner {
                font-size: 0.9rem;
                padding: 8px 10px;
            }
            
            .breaking-news-title {
                font-size: 1rem;
            }
            
            #leaderboard-table th,
            #leaderboard-table td {
                padding: 8px 5px;
                font-size: 0.8rem;
            }

            .player-name {
                max-width: 80px;
            }
            
            #boost-button {
                padding: 12px 8px;
                min-height: 70px;
            }
            
            .boost-percentage {
                font-size: 1.4rem;
            }
            
            .boost-label {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>

<!-- NEW: Name Selection Modal -->
<div id="name-selection-modal">
    <div class="name-modal-content">
        <div class="name-modal-title">The News Bruh</div>
        <div class="name-modal-subtitle">Enter the Press Room</div>
        
        <div class="name-input-container">
            <input type="text" id="player-name-input" placeholder="Type your newsroom name..." maxlength="20" autofocus>
            <div class="name-rules">
                <strong>Name Rules:</strong>
                <ul>
                    <li>Maximum 20 characters</li>
                    <li>Almost any character allowed (letters, numbers, spaces, symbols)</li>
                    <li>Your name will appear on the leaderboard</li>
                    <li>Other players can tag you in chat using @name</li>
                    <li>Note: @ symbol is reserved for tagging system</li>
                </ul>
            </div>
        </div>
        
        <button class="start-game-btn" onclick="startGameWithName()">
            START PRINTING
        </button>
    </div>
</div>

<div id="newspaper" style="display: none;">
    <div id="ticker-tape">
        <div class="ticker-content" id="ticker-text">
            Join <a href="https://www.reddit.com/r/thenewsbruh/s/HPIdtW6H3X" target="_blank">r/TheNewsBruh</a> on Reddit & Reach The Top 3 on The Leaderboard to Earn Real New Token &nbsp;&bull;&nbsp; EXTRA! EXTRA!
        </div>
    </div>

    <header>
        <h1>The News Bruh</h1>
        
        <div class="player-counts">
            <span>Players Online: <span id="online-count">0</span></span>
            <span>Total Players: <span id="total-count">0</span></span>
        </div>

        <div class="meta-line">
            <span>Vol. 1</span>
            <span>Est. 2026</span>
            <span id="currentDateTime">Loading...</span>
        </div>
    </header>

    <div id="main-content">
        
        <div class="column" id="col-left">
            <h2>Statistics</h2>
            
            <div class="stat-block">
                <div class="stat-label">Treasury</div>
                <div class="stat-value"><span id="currency">0</span> New</div>
            </div>

            <div class="stat-block">
                <div class="stat-label">Production</div>
                <div class="stat-value"><span id="cps">0.0</span> / sec</div>
            </div>

            <div class="stat-block">
                <div class="stat-label">Market Multiplier</div>
                <div class="stat-value" style="color: var(--red-accent);">x<span id="multiplier">1</span></div>
            </div>

            <div class="prestige-box">
                <h3 style="margin:0 0 10px 0; border-bottom: 1px solid var(--ink);">THE CLASSIFIEDS</h3>
                <p style="font-size: 0.85rem; margin-bottom: 10px; line-height: 1.4;">
                    Hire a <strong>Bruh</strong> Consultant. Each Bruh owned adds a <strong>+100% (x1)</strong> permanent bonus to all production.
                </p>
                <div style="font-weight: bold; margin-bottom: 5px; font-size: 1.1rem;">Bruh Owned: <span id="bruh-owned">0</span></div>
                <button id="prestige-btn" class="prestige-btn" onclick="prestige()">
                    Buy Bruh
                    <div id="prestige-cost" class="prestige-cost">Costs: 1k New</div>
                    <div id="prestige-max" class="prestige-max">Max: 0</div>
                </button>
            </div>
        </div>

        <div class="column" id="col-center">
            <h2>Front Page</h2>
            
            <!-- ENHANCED: Breaking News Banner (now without timer) -->
            <div id="breaking-news-container">
                <div id="breaking-news-banner">
                    <div class="breaking-news-text">
                        <span class="breaking-news-icon">üì∞</span>
                        <span class="breaking-news-title">BREAKING NEWS: 5X MULTIPLIER ACTIVE!</span>
                    </div>
                </div>
            </div>
            
            <button id="print-btn">
                <span class="print-title">PRINT EDITION</span>
                <span class="print-sub" id="tap-value-display">üì∞ +1 New per Tap</span>
            </button>

            <!-- ENHANCED: Boost Button -->
            <div id="boost-container">
                <button id="boost-button">
                    <div id="boost-progress-bar"></div>
                    <div class="boost-content">
                        <span class="boost-percentage" id="boost-percentage">0%</span>
                        <span class="boost-label">BREAKING NEWS BOOST</span>
                        <span class="boost-timer" id="boost-timer">15s</span>
                        <span class="boost-cooldown" id="boost-cooldown"></span>
                    </div>
                </button>
            </div>

            <div class="headline-box">
                <strong>Latest Headline:</strong>
                <p id="headline-spot">
                    "Local entrepreneur starts printing press in garage, neighbors concerned about noise."
                </p>
            </div>

            <div style="text-align: center; margin-top: 20px; opacity: 0.6;">
                <div style="font-family: var(--font-mono); font-size: 0.8rem; margin-bottom: 10px;">ADVERTISEMENT</div>
                <div style="width: 100px; height: 100px; background: var(--bg-paper-dark); border: 2px solid var(--ink); margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-family: var(--font-mono);">
                    PRESS<br>HERE
                </div>
            </div>
        </div>

        <div class="column" id="col-right">
            <h2>Assets</h2>
            <div id="upgrades-list">
                <!-- Upgrades will be dynamically inserted here -->
            </div>
        </div>

    </div>

    <!-- NEW: Leaderboard Section -->
    <div id="leaderboard-section">
        <div class="leaderboard-header">
            <h2 style="border-bottom: none; margin: 0;">üèÜ Leaderboard üèÜ</h2>
            <div id="leaderboard-update-time" style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--ink-light);">
                Updated: Just now
            </div>
        </div>
        <table id="leaderboard-table">
            <thead>
                <tr>
                    <th style="width: 60px;">RANK</th>
                    <th>PLAYER</th>
                    <th style="width: 120px;">BRUH COUNT</th>
                    <th style="width: 100px;">LEVEL</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                <!-- Leaderboard rows will be inserted here -->
            </tbody>
        </table>
    </div>

    <!-- NEW: Chat Section -->
    <div id="chat-section">
        <div class="chat-container">
            <div class="chat-header">
                <span>üì∞ PRESS ROOM CHAT</span>
                <span id="chat-status">Connecting...</span>
            </div>
            <div id="chat-messages">
                <!-- Chat messages will be inserted here -->
                <div class="chat-message other">
                    <div class="message-sender">System <span class="message-timestamp">Just now</span></div>
                    <div class="message-content">Connecting to live chat...</div>
                </div>
            </div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Type your message... (Use @name to tag players)" maxlength="200">
                <button id="chat-send" onclick="sendChatMessage()">SEND</button>
            </div>
        </div>
        
        <div class="chat-users">
            <div class="users-header">
                <span>üü¢ ONLINE PLAYERS (<span id="online-users-count">0</span>)</span>
            </div>
            <div id="online-users">
                <!-- Online users will be inserted here -->
            </div>
        </div>
    </div>
</div>

<!-- Chat Notification -->
<div id="chat-notification" class="chat-notification" style="display: none;">
    <div class="notification-sender" id="notification-sender"></div>
    <div class="notification-message" id="notification-message"></div>
</div>

<script>
    // ===============================
    // SUPABASE CONFIGURATION
    // ===============================
    const SUPABASE_URL = 'https://qlwtovkrmfoqfgrtynrv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsd3RvdmtybWZvcWZncnR5bnJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNzE4NTksImV4cCI6MjA4Mzg0Nzg1OX0.XMPhSftpLtTeM3gTS0Acf6DrFuI_H0U-iAfxAas9n8Y';
    
    // Initialize Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Player session ID
    let playerSessionId = localStorage.getItem('newsBruhSessionId');
    if (!playerSessionId) {
        playerSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('newsBruhSessionId', playerSessionId);
    }
    
    let currentPlayerId = null;
    let isSupabaseConnected = false;
    let lastPlayerUpdate = 0;
    let playerUpdateInterval = null;

    // ===============================
    // SUPABASE FUNCTIONS
    // ===============================
    
    async function checkSupabaseConnection() {
        try {
            const { data, error } = await supabase
                .from('players')
                .select('count')
                .limit(1);
            
            if (error) throw error;
            return true;
        } catch (error) {
            console.error('Supabase connection error:', error);
            return false;
        }
    }
    
    async function createOrUpdatePlayer(name, initialData = {}) {
        try {
            // Check if player already exists
            const { data: existingPlayer, error: fetchError } = await supabase
                .from('players')
                .select('*')
                .eq('name', name)
                .maybeSingle();
            
            if (fetchError) throw fetchError;
            
            if (existingPlayer) {
                // Update existing player
                const { data: updatedPlayer, error: updateError } = await supabase
                    .from('players')
                    .update({
                        session_id: playerSessionId,
                        last_active: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', existingPlayer.id)
                    .select()
                    .single();
                
                if (updateError) throw updateError;
                
                currentPlayerId = updatedPlayer.id;
                return updatedPlayer;
            } else {
                // Create new player
                const { data: newPlayer, error: insertError } = await supabase
                    .from('players')
                    .insert([{
                        name: name,
                        session_id: playerSessionId,
                        total_news: initialData.news || 0,
                        bruh_count: initialData.bruh || 0,
                        level: initialData.level || 1,
                        last_active: new Date().toISOString(),
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                
                if (insertError) throw insertError;
                
                currentPlayerId = newPlayer.id;
                return newPlayer;
            }
        } catch (error) {
            console.error('Error creating/updating player:', error);
            return null;
        }
    }
    
    async function updatePlayerStats() {
        if (!currentPlayerId || !isSupabaseConnected) return;
        
        // Calculate level
        const level = calculateLevel(gameState.bruh, gameState.news);
        
        try {
            const { error } = await supabase
                .from('players')
                .update({
                    total_news: gameState.news,
                    bruh_count: gameState.bruh,
                    level: level,
                    last_active: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                })
                .eq('id', currentPlayerId);
            
            if (error) throw error;
            lastPlayerUpdate = Date.now();
        } catch (error) {
            console.error('Error updating player stats:', error);
        }
    }
    
    async function getOnlinePlayersCount() {
        try {
            // Get players active in last 5 minutes
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
            
            const { count, error } = await supabase
                .from('players')
                .select('*', { count: 'exact', head: true })
                .gte('last_active', fiveMinutesAgo);
            
            if (error) throw error;
            return count || 0;
        } catch (error) {
            console.error('Error getting online players count:', error);
            return 0;
        }
    }
    
    async function getTotalPlayersCount() {
        try {
            const { count, error } = await supabase
                .from('players')
                .select('*', { count: 'exact', head: true });
            
            if (error) throw error;
            return count || 0;
        } catch (error) {
            console.error('Error getting total players count:', error);
            return 0;
        }
    }
    
    async function updatePlayerCounts() {
        try {
            const onlineCount = await getOnlinePlayersCount();
            const totalCount = await getTotalPlayersCount();
            
            document.getElementById('online-count').textContent = formatNumber(onlineCount);
            document.getElementById('total-count').textContent = formatNumber(totalCount);
        } catch (error) {
            console.error('Error updating player counts:', error);
        }
    }
    
    async function getLeaderboardData() {
        try {
            const { data, error } = await supabase
                .from('players')
                .select('id, name, bruh_count, total_news, level, last_active')
                .order('bruh_count', { ascending: false })
                .order('total_news', { ascending: false })
                .limit(20);
            
            if (error) throw error;
            return data || [];
        } catch (error) {
            console.error('Error getting leaderboard data:', error);
            return [];
        }
    }
    
    async function updateLeaderboard() {
        try {
            const leaderboardData = await getLeaderboardData();
            const tbody = document.getElementById('leaderboard-body');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Update timestamp
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const updateTimeElement = document.getElementById('leaderboard-update-time');
            if (updateTimeElement) {
                updateTimeElement.textContent = `Updated: ${timeStr}`;
            }
            
            // Display players
            leaderboardData.forEach((player, index) => {
                const row = document.createElement('tr');
                const rank = index + 1;
                
                // Highlight current player
                if (player.id === currentPlayerId) {
                    row.style.backgroundColor = '#e8f5e8';
                    row.style.fontWeight = 'bold';
                }
                
                // Add rank class for top 3
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';
                
                row.innerHTML = `
                    <td class="player-rank ${rankClass}">${rank}</td>
                    <td class="player-name">${escapeHtml(player.name)} ${player.id === currentPlayerId ? ' (You)' : ''}</td>
                    <td class="player-bruh">${formatNumber(player.bruh_count)}</td>
                    <td class="player-level">${formatNumber(player.level)}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            // If current player is not in top 20, find and add them
            if (currentPlayerId) {
                const currentPlayerIndex = leaderboardData.findIndex(p => p.id === currentPlayerId);
                if (currentPlayerIndex === -1 || currentPlayerIndex >= 20) {
                    try {
                        const { data: currentPlayer, error } = await supabase
                            .from('players')
                            .select('id, name, bruh_count, total_news, level')
                            .eq('id', currentPlayerId)
                            .single();
                        
                        if (!error && currentPlayer) {
                            // Find rank by getting count of players with higher bruh_count
                            const { count: higherRankCount, error: rankError } = await supabase
                                .from('players')
                                .select('*', { count: 'exact', head: true })
                                .gt('bruh_count', currentPlayer.bruh_count);
                            
                            if (!rankError) {
                                const rank = (higherRankCount || 0) + 1;
                                const row = document.createElement('tr');
                                row.style.backgroundColor = '#e8f5e8';
                                row.style.fontWeight = 'bold';
                                
                                let rankClass = '';
                                if (rank === 1) rankClass = 'rank-1';
                                else if (rank === 2) rankClass = 'rank-2';
                                else if (rank === 3) rankClass = 'rank-3';
                                
                                row.innerHTML = `
                                    <td class="player-rank ${rankClass}">${rank}</td>
                                    <td class="player-name">${escapeHtml(currentPlayer.name)} (You)</td>
                                    <td class="player-bruh">${formatNumber(currentPlayer.bruh_count)}</td>
                                    <td class="player-level">${formatNumber(currentPlayer.level)}</td>
                                `;
                                
                                tbody.appendChild(row);
                            }
                        }
                    } catch (error) {
                        console.error('Error adding current player to leaderboard:', error);
                    }
                }
            }
        } catch (error) {
            console.error('Error updating leaderboard:', error);
        }
    }
    
    async function getOnlinePlayers() {
        try {
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
            
            const { data, error } = await supabase
                .from('players')
                .select('id, name, bruh_count, last_active')
                .gte('last_active', fiveMinutesAgo)
                .order('bruh_count', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            return data || [];
        } catch (error) {
            console.error('Error getting online players:', error);
            return [];
        }
    }
    
    async function updateOnlinePlayers() {
        try {
            const onlinePlayers = await getOnlinePlayers();
            const container = document.getElementById('online-users');
            const countElement = document.getElementById('online-users-count');
            
            if (!container || !countElement) return;
            
            // Update count
            countElement.textContent = onlinePlayers.length;
            
            // Update list
            container.innerHTML = '';
            
            onlinePlayers.forEach(player => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                
                userDiv.innerHTML = `
                    <div>
                        <span class="user-online"></span>
                        <span class="user-name">${escapeHtml(player.name)}</span>
                    </div>
                    <div class="user-bruh">${formatNumber(player.bruh_count)} Bruh</div>
                `;
                
                container.appendChild(userDiv);
            });
        } catch (error) {
            console.error('Error updating online players:', error);
        }
    }
    
    async function sendChatMessageToSupabase(message, sender) {
        try {
            const { error } = await supabase
                .from('chat_messages')
                .insert([{
                    sender: sender,
                    content: message,
                    session_id: playerSessionId,
                    created_at: new Date().toISOString()
                }]);
            
            if (error) throw error;
            return true;
        } catch (error) {
            console.error('Error sending chat message:', error);
            return false;
        }
    }
    
    async function getChatMessages() {
        try {
            const { data, error } = await supabase
                .from('chat_messages')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            return (data || []).reverse(); // Reverse to show oldest first at top
        } catch (error) {
            console.error('Error getting chat messages:', error);
            return [];
        }
    }
    
    async function updateChatDisplay() {
        try {
            const chatMessages = await getChatMessages();
            const chatContainer = document.getElementById('chat-messages');
            
            if (!chatContainer) return;
            
            chatContainer.innerHTML = '';
            
            chatMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.sender === gameState.playerName ? 'self' : 'other'}`;
                
                // Check if this message tags the current player
                if (msg.content.includes(`@${gameState.playerName}`) && msg.sender !== gameState.playerName) {
                    messageDiv.classList.add('tagged');
                }
                
                // Format timestamp
                const timestamp = new Date(msg.created_at);
                const timeStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Format message content with highlighted tags
                let content = escapeHtml(msg.content);
                // Allow special characters in tagged names
                content = content.replace(/@([^\s@]+)/g, '<span class="tagged-player">@$1</span>');
                
                messageDiv.innerHTML = `
                    <div class="message-sender">${escapeHtml(msg.sender)} <span class="message-timestamp">${timeStr}</span></div>
                    <div class="message-content">${content}</div>
                `;
                
                chatContainer.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } catch (error) {
            console.error('Error updating chat display:', error);
        }
    }
    
    function setupRealtimeSubscriptions() {
        if (!isSupabaseConnected) return;
        
        // Subscribe to chat messages
        const chatSubscription = supabase
            .channel('chat-channel')
            .on('postgres_changes', 
                { event: 'INSERT', schema: 'public', table: 'chat_messages' }, 
                (payload) => {
                    // Update chat display when new message arrives
                    updateChatDisplay();
                    
                    // Show notification if tagged
                    const newMessage = payload.new;
                    if (newMessage.content.includes(`@${gameState.playerName}`) && 
                        newMessage.sender !== gameState.playerName &&
                        gameState.chatNotifications) {
                        showChatNotification(newMessage.sender, newMessage.content);
                    }
                }
            )
            .subscribe();
        
        // Subscribe to leaderboard updates
        const leaderboardSubscription = supabase
            .channel('leaderboard-channel')
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'players' }, 
                (payload) => {
                    // Update leaderboard when player data changes
                    updateLeaderboard();
                    updateOnlinePlayers();
                    updatePlayerCounts();
                }
            )
            .subscribe();
        
        return { chatSubscription, leaderboardSubscription };
    }
    
    // ===============================
    // HELPER FUNCTIONS
    // ===============================
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function validatePlayerName(name) {
        if (!name || name.trim() === '') {
            alert('Please enter a name!');
            return false;
        }
        
        if (name.length > 20) {
            alert('Name must be 20 characters or less!');
            return false;
        }
        
        // Allow most characters, but prevent potential security issues
        if (name.includes('@') && name.indexOf('@') === 0) {
            alert('Name cannot start with @ (reserved for tagging system)');
            return false;
        }
        
        // Check for excessive special characters that might cause issues
        const excessiveSpecialChars = /[<>{}[\]\\]/;
        if (excessiveSpecialChars.test(name)) {
            alert('Name contains invalid characters: < > { } [ ] \\ are not allowed');
            return false;
        }
        
        return true;
    }
    
    // NEW: Live Date & Time Display
    function updateDateTime() {
        const now = new Date();
        
        // Format day with leading zero
        const day = String(now.getDate()).padStart(2, '0');
        
        // Format month with leading zero (months are 0-indexed in JavaScript)
        const month = String(now.getMonth() + 1).padStart(2, '0');
        
        // Get full year
        const year = now.getFullYear();
        
        // Format time with leading zeros
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        
        // Create the formatted string: dd/mm/yyyy HH:MM:SS
        const dateTimeString = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        
        // Update the element
        const dateTimeElement = document.getElementById('currentDateTime');
        if (dateTimeElement) {
            dateTimeElement.textContent = dateTimeString;
        }
    }
    
    // Start updating the date/time every second
    function startDateTimeUpdate() {
        // Update immediately
        updateDateTime();
        
        // Then update every second
        setInterval(updateDateTime, 1000);
    }
    
    // Fixed Game State Management
    const defaultGameState = {
        news: 0,
        bruh: 0,
        buildings: [
            { id: 0, name: "Paperboy", baseCost: 15, baseCPS: 0.5, count: 0 },
            { id: 1, name: "Editor", baseCost: 100, baseCPS: 4, count: 0 },
            { id: 2, name: "Printing Press", baseCost: 1100, baseCPS: 12, count: 0 },
            { id: 3, name: "Distribution Van", baseCost: 12000, baseCPS: 45, count: 0 },
            { id: 4, name: "News Tower", baseCost: 130000, baseCPS: 160, count: 0 },
            { id: 5, name: "Media Empire", baseCost: 1400000, baseCPS: 850, count: 0 }
        ],
        lastUpdate: Date.now(),
        version: "2.0.0",
        playerName: "",
        chatNotifications: true,
        // ENHANCED: Boost System State
        boostProgress: 0,
        isBoostActive: false,
        boostTimeLeft: 0,
        boostCooldown: 0,
        boostMultiplier: 1,
        lastDepletionTime: Date.now()
    };
    
    let gameState = JSON.parse(JSON.stringify(defaultGameState));
    let isInitialized = false;
    
    // ENHANCED: Boost system variables
    let breakingNewsEmojis = [];
    let boostEmojiInterval = null;
    let boostTimerInterval = null;
    
    // NEW: Chat System Variables
    let lastLeaderboardUpdate = 0;
    
    // INFINITE ALPHABETICAL NUMBER SYSTEM
    // ===================================
    function formatNumber(num) {
        if (typeof num !== 'number' || !isFinite(num)) return '0';
        if (num < 0) return '-' + formatNumber(-num);
        if (num < 1000) return Math.floor(num).toLocaleString();
        
        // Convert to infinite alphabetical system
        return toAlphabetical(num);
    }
    
    // New: Infinite alphabetical number system
    function toAlphabetical(num) {
        // Handle scientific notation for very large numbers
        if (num >= 1e6) {
            // Use log10 to determine the magnitude
            const log = Math.log10(num);
            const magnitude = Math.floor(log / 3); // Every 3 orders of magnitude = new letter group
            
            if (magnitude < 1) return Math.floor(num).toLocaleString();
            
            // Calculate the base value (1e3, 1e6, 1e9, etc.)
            const baseValue = Math.pow(1000, magnitude);
            const scaled = num / baseValue;
            
            // Get the letter suffix for this magnitude
            const suffix = getAlphabeticalSuffix(magnitude - 1);
            
            // Format with 2 decimal places for readability
            if (scaled >= 100) {
                return Math.floor(scaled) + suffix;
            } else if (scaled >= 10) {
                return scaled.toFixed(1) + suffix;
            } else {
                return scaled.toFixed(2) + suffix;
            }
        }
        
        // Traditional formatting for smaller numbers
        if (num >= 1e15) return (num / 1e15).toFixed(2) + "Qa";
        if (num >= 1e12) return (num / 1e12).toFixed(2) + "T";
        if (num >= 1e9) return (num / 1e9).toFixed(2) + "B";
        if (num >= 1e6) return (num / 1e6).toFixed(2) + "M";
        if (num >= 1e3) return (num / 1e3).toFixed(1) + "k";
        
        return Math.floor(num).toLocaleString();
    }
    
    // New: Generate alphabetical suffixes infinitely
    function getAlphabeticalSuffix(index) {
        if (index < 0) return "";
        
        // First 26: a-z (for magnitudes 0-25)
        if (index < 26) {
            return String.fromCharCode(97 + index); // 97 = 'a'
        }
        
        // For indices >= 26, we need to build a multi-letter suffix
        let result = "";
        let remaining = index;
        
        while (remaining >= 0) {
            // Get the current character (0-25 = a-z)
            const charIndex = remaining % 26;
            result = String.fromCharCode(97 + charIndex) + result;
            
            // Move to next "digit" (like base-26 counting)
            remaining = Math.floor(remaining / 26) - 1;
            
            if (remaining < 0) break;
        }
        
        return result;
    }
    
    // NEW: Calculate player level based on bruh count and news
    const calculateLevel = (bruh, news) => {
        return Math.floor(Math.sqrt(bruh * 10 + news / 1000));
    };
    
    // ENHANCED: Boost System Functions
    function updateBoostProgress() {
        const boostButton = document.getElementById('boost-button');
        const progressBar = document.getElementById('boost-progress-bar');
        const percentageElement = document.getElementById('boost-percentage');
        const cooldownElement = document.getElementById('boost-cooldown');
        const timerElement = document.getElementById('boost-timer');
        
        if (gameState.boostCooldown > 0) {
            // In cooldown
            boostButton.disabled = true;
            const minutes = Math.floor(gameState.boostCooldown / 60);
            const seconds = Math.floor(gameState.boostCooldown % 60);
            cooldownElement.textContent = `Cooldown: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            cooldownElement.style.display = 'block';
            timerElement.style.display = 'none';
            percentageElement.textContent = '0%';
            progressBar.style.width = '0%';
            progressBar.style.background = 'linear-gradient(90deg, #cccccc, #999999)';
        } else if (gameState.isBoostActive) {
            // Boost is active
            boostButton.disabled = false;
            percentageElement.textContent = 'ACTIVE!';
            percentageElement.style.color = '#ff0000';
            percentageElement.style.textShadow = '0 0 10px rgba(255, 0, 0, 0.8)';
            progressBar.style.width = '100%';
            progressBar.style.background = 'linear-gradient(90deg, #ff0000, #ff8800, #ff0000)';
            progressBar.style.animation = 'progressShimmer 1s infinite linear';
            cooldownElement.style.display = 'none';
            timerElement.style.display = 'block';
            timerElement.textContent = `${gameState.boostTimeLeft}s`;
        } else {
            // Normal charging state
            boostButton.disabled = false;
            percentageElement.style.color = '';
            percentageElement.style.textShadow = '';
            percentageElement.textContent = `${Math.floor(gameState.boostProgress)}%`;
            progressBar.style.width = `${gameState.boostProgress}%`;
            progressBar.style.background = 'linear-gradient(90deg, #ff4444, #ff0000, #ff4444)';
            progressBar.style.animation = 'progressShimmer 2s infinite linear';
            cooldownElement.style.display = 'none';
            timerElement.style.display = 'none';
            
            // Update cooldown display
            if (gameState.boostProgress >= 100) {
                cooldownElement.textContent = 'READY!';
                cooldownElement.style.display = 'block';
                cooldownElement.style.color = '#ff0000';
                cooldownElement.style.background = 'rgba(255, 0, 0, 0.2)';
            } else {
                cooldownElement.style.display = 'none';
            }
        }
    }
    
    // NEW: Deplete boost progress over time
    function depleteBoostProgress() {
        if (gameState.isBoostActive || gameState.boostCooldown > 0 || gameState.boostProgress <= 0) {
            return;
        }
        
        const now = Date.now();
        const timeSinceLastDepletion = (now - gameState.lastDepletionTime) / 1000; // Convert to seconds
        
        // Deplete 2% per second
        if (timeSinceLastDepletion >= 1) {
            gameState.boostProgress = Math.max(0, gameState.boostProgress - 2);
            gameState.lastDepletionTime = now;
            
            // Update display if needed
            if (gameState.boostProgress % 10 === 0 || gameState.boostProgress <= 1) {
                updateBoostProgress();
            }
        }
    }
    
    function incrementBoostProgress() {
        if (gameState.isBoostActive || gameState.boostCooldown > 0) {
            return;
        }
        
        // Each click adds 5% progress
        gameState.boostProgress += 5;
        
        // Reset depletion timer
        gameState.lastDepletionTime = Date.now();
        
        // AUTO-ACTIVATE when reaching 100%
        if (gameState.boostProgress >= 100) {
            gameState.boostProgress = 100;
            activateBoost(); // Auto-activate immediately
        }
        
        updateBoostProgress();
        saveGame();
    }
    
    function activateBoost() {
        if (gameState.isBoostActive || gameState.boostProgress < 100) return;
        
        gameState.isBoostActive = true;
        gameState.boostTimeLeft = 15; // 15 seconds
        gameState.boostMultiplier = 5; // 5x multiplier
        gameState.boostProgress = 0;
        
        // Show enhanced breaking news banner
        const banner = document.getElementById('breaking-news-banner');
        banner.style.display = 'block';
        
        // Start dropping emojis
        startEmojiRain();
        
        // Update timer display
        updateBoostTimer();
        
        // Start boost timer
        if (boostTimerInterval) clearInterval(boostTimerInterval);
        boostTimerInterval = setInterval(updateBoostTimer, 1000);
        
        // Add visual effect to stats
        const statBlocks = document.querySelectorAll('.stat-block');
        statBlocks.forEach(block => {
            block.classList.add('active-boost');
        });
        
        // Update UI immediately
        updateUI();
        updateBoostProgress();
        
        // Play a sound effect if available (optional)
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } catch (e) {
            // Audio not supported, continue silently
        }
    }
    
    function updateBoostTimer() {
        if (!gameState.isBoostActive) return;
        
        gameState.boostTimeLeft--;
        
        // Update timer displays
        const timerElement = document.getElementById('boost-timer');
        
        if (timerElement) {
            timerElement.textContent = `${gameState.boostTimeLeft}s`;
            
            // Flash red when time is running low
            if (gameState.boostTimeLeft <= 5) {
                timerElement.style.animation = 'none';
                setTimeout(() => {
                    timerElement.style.animation = 'pulseTimer 0.5s infinite alternate';
                }, 10);
                timerElement.style.color = '#ff0000';
                timerElement.style.borderColor = '#ff0000';
            }
        }
        
        if (gameState.boostTimeLeft <= 0) {
            endBoost();
        }
    }
    
    function resetBoostTimer() {
        if (!gameState.isBoostActive) return;
        
        // Reset timer to 15 seconds when print edition is clicked
        gameState.boostTimeLeft = 15;
        
        // Update timer displays
        const timerElement = document.getElementById('boost-timer');
        
        if (timerElement) {
            timerElement.textContent = `${gameState.boostTimeLeft}s`;
            timerElement.style.color = '#ff0000';
            timerElement.style.borderColor = '#ff0000';
        }
        
        // Visual feedback on banner
        const banner = document.getElementById('breaking-news-banner');
        banner.style.transform = 'perspective(500px) rotateX(5deg) scale(1.05)';
        banner.style.boxShadow = '0 6px 25px rgba(255, 0, 0, 0.6), inset 0 0 25px rgba(255, 255, 255, 0.4)';
        
        setTimeout(() => {
            banner.style.transform = 'perspective(500px) rotateX(5deg)';
            banner.style.boxShadow = '0 4px 20px rgba(255, 0, 0, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.3)';
        }, 300);
    }
    
    function endBoost() {
        gameState.isBoostActive = false;
        gameState.boostMultiplier = 1;
        gameState.boostCooldown = 600; // 10 minutes cooldown = 600 seconds
        
        // Hide breaking news banner
        const banner = document.getElementById('breaking-news-banner');
        banner.style.display = 'none';
        
        // Stop dropping emojis
        stopEmojiRain();
        
        // Clear boost timer interval
        if (boostTimerInterval) {
            clearInterval(boostTimerInterval);
            boostTimerInterval = null;
        }
        
        // Remove visual effect from stats
        const statBlocks = document.querySelectorAll('.stat-block');
        statBlocks.forEach(block => {
            block.classList.remove('active-boost');
        });
        
        // Start cooldown timer
        const cooldownInterval = setInterval(() => {
            gameState.boostCooldown--;
            updateBoostProgress();
            
            if (gameState.boostCooldown <= 0) {
                clearInterval(cooldownInterval);
                gameState.boostCooldown = 0;
                updateBoostProgress();
            }
        }, 1000);
        
        // Update UI
        updateUI();
        updateBoostProgress();
    }
    
    function startEmojiRain() {
        // Clear any existing interval
        if (boostEmojiInterval) clearInterval(boostEmojiInterval);
        
        // Create falling emojis every 300ms for more intense effect
        boostEmojiInterval = setInterval(() => {
            createFallingEmoji();
            // Sometimes create two at once
            if (Math.random() > 0.5) {
                setTimeout(createFallingEmoji, 150);
            }
        }, 300);
    }
    
    function stopEmojiRain() {
        if (boostEmojiInterval) {
            clearInterval(boostEmojiInterval);
            boostEmojiInterval = null;
        }
        
        // Remove all emojis
        breakingNewsEmojis.forEach(emoji => {
            if (emoji.parentNode) {
                emoji.parentNode.removeChild(emoji);
            }
        });
        breakingNewsEmojis = [];
    }
    
    function createFallingEmoji() {
        const banner = document.getElementById('breaking-news-container');
        if (!banner) return;
        
        const emoji = document.createElement('div');
        emoji.className = 'breaking-news-flash';
        emoji.textContent = 'üì∞';
        
        // Random position across the entire newspaper width
        const newspaper = document.getElementById('newspaper');
        const newspaperRect = newspaper.getBoundingClientRect();
        const bannerRect = banner.getBoundingClientRect();
        
        // Start position relative to newspaper
        const startX = Math.random() * newspaperRect.width;
        const startY = bannerRect.top - newspaperRect.top;
        
        emoji.style.left = `${startX}px`;
        emoji.style.top = `${startY}px`;
        emoji.style.fontSize = `${Math.random() * 20 + 20}px`;
        emoji.style.animationDuration = `${Math.random() * 1 + 1.5}s`;
        
        // Random rotation direction
        emoji.style.transform = `rotate(${Math.random() > 0.5 ? '' : '-'}${Math.random() * 30}deg)`;
        
        newspaper.appendChild(emoji);
        breakingNewsEmojis.push(emoji);
        
        // Remove emoji after animation
        setTimeout(() => {
            if (emoji.parentNode) {
                emoji.parentNode.removeChild(emoji);
                const index = breakingNewsEmojis.indexOf(emoji);
                if (index > -1) {
                    breakingNewsEmojis.splice(index, 1);
                }
            }
        }, 2000);
    }
    
    // Fixed Helper Functions
    const getPrestigeCost = (bruhCount) => {
        return Math.floor(1000 * Math.pow(2.5, bruhCount));
    };
    
    const getMultiplier = () => {
        const bruh = gameState.bruh || 0;
        // Handle very large numbers safely
        if (bruh > 1e12) {
            // Use logarithmic scaling for extreme values
            return (1 + Math.pow(Math.log10(bruh + 1), 2)) * gameState.boostMultiplier;
        }
        return (1 + bruh) * gameState.boostMultiplier;
    };
    
    const getCost = (building) => {
        const count = building.count || 0;
        const baseCost = building.baseCost || 15;
        
        // Handle very large counts safely
        if (count > 1000) {
            // Use exponential scaling but cap the growth rate
            const exponent = Math.min(count, 10000) * 0.15;
            return Math.floor(baseCost * Math.pow(1.15, Math.min(exponent, 100)));
        }
        
        return Math.floor(baseCost * Math.pow(1.15, count));
    };
    
    const getCPS = () => {
        let base = gameState.buildings.reduce((acc, b) => acc + (b.count * b.baseCPS), 0);
        return base * getMultiplier();
    };
    
    const getMaxBuy = (building) => {
        let canBuy = 0;
        let tempNews = gameState.news;
        let tempCount = building.count;
        
        // Safety limit
        const maxIterations = 1000;
        
        for (let i = 0; i < maxIterations; i++) {
            let nextCost = getCost({...building, count: tempCount});
            if (tempNews >= nextCost) {
                canBuy++;
                tempNews -= nextCost;
                tempCount++;
            } else {
                break;
            }
        }
        
        return canBuy;
    };
    
    // NEW: Chat System Functions
    async function sendChatMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message || message.length === 0) return;
        
        if (message.length > 200) {
            alert('Message too long (max 200 characters)');
            return;
        }
        
        if (!gameState.playerName) {
            alert('Please enter your name first!');
            return;
        }
        
        // Send message to Supabase
        const success = await sendChatMessageToSupabase(message, gameState.playerName);
        
        if (success) {
            // Clear input
            input.value = '';
            
            // Update chat display
            updateChatDisplay();
        } else {
            alert('Failed to send message. Please try again.');
        }
    }
    
    function showChatNotification(sender, message) {
        const notification = document.getElementById('chat-notification');
        const notificationSender = document.getElementById('notification-sender');
        const notificationMessage = document.getElementById('notification-message');
        
        // Truncate message if too long
        const truncatedMessage = message.length > 50 ? message.substring(0, 47) + '...' : message;
        
        notificationSender.textContent = `üì® ${sender} tagged you!`;
        notificationMessage.textContent = truncatedMessage;
        
        notification.style.display = 'block';
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            notification.style.display = 'none';
        }, 5000);
        
        // Click to hide
        notification.onclick = () => {
            notification.style.display = 'none';
        };
    }
    
    async function startGameWithName() {
        const nameInput = document.getElementById('player-name-input');
        const playerName = nameInput.value.trim();
        
        if (!validatePlayerName(playerName)) {
            return;
        }
        
        // Show loading state
        const startBtn = document.querySelector('.start-game-btn');
        startBtn.textContent = 'CONNECTING...';
        startBtn.disabled = true;
        
        try {
            // Test Supabase connection
            isSupabaseConnected = await checkSupabaseConnection();
            
            if (!isSupabaseConnected) {
                alert('Cannot connect to server. Playing in offline mode.');
            }
            
            // Create or update player in Supabase
            const playerData = await createOrUpdatePlayer(playerName, {
                news: gameState.news,
                bruh: gameState.bruh,
                level: calculateLevel(gameState.bruh, gameState.news)
            });
            
            if (playerData) {
                currentPlayerId = playerData.id;
                
                // Save the player name locally
                localStorage.setItem('newsBruhPlayerName', playerName);
                gameState.playerName = playerName;
                
                // Hide name selection modal
                document.getElementById('name-selection-modal').classList.add('hidden');
                
                // Show the game
                document.getElementById('newspaper').style.display = 'flex';
                
                // Update chat status
                document.getElementById('chat-status').textContent = isSupabaseConnected ? 'Connected' : 'Offline';
                
                // Initialize the game
                init();
            } else {
                alert('Failed to create player. Please try again.');
                startBtn.textContent = 'START PRINTING';
                startBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error starting game:', error);
            alert('Error connecting to server. Starting in offline mode.');
            
            // Save the player name locally
            localStorage.setItem('newsBruhPlayerName', playerName);
            gameState.playerName = playerName;
            
            // Hide name selection modal
            document.getElementById('name-selection-modal').classList.add('hidden');
            
            // Show the game
            document.getElementById('newspaper').style.display = 'flex';
            
            // Update chat status
            document.getElementById('chat-status').textContent = 'Offline';
            
            // Initialize the game
            init();
        }
    }
    
    function saveGame() {
        try {
            gameState.lastUpdate = Date.now();
            localStorage.setItem('newsBruhGameState', JSON.stringify(gameState));
            
            // Update player stats in Supabase if connected
            if (isSupabaseConnected && currentPlayerId && Date.now() - lastPlayerUpdate > 30000) {
                updatePlayerStats();
            }
        } catch (e) {
            console.warn('Could not save game state:', e);
        }
    }
    
    function loadGame() {
        try {
            const saved = localStorage.getItem('newsBruhGameState');
            if (saved) {
                const parsed = JSON.parse(saved);
                
                // Migrate old saves if needed
                if (!parsed.version || parsed.version !== defaultGameState.version) {
                    console.log('Migrating save data...');
                    // Keep building counts if they exist
                    if (parsed.buildings && Array.isArray(parsed.buildings)) {
                        parsed.buildings.forEach((savedBuilding, index) => {
                            if (gameState.buildings[index]) {
                                gameState.buildings[index].count = savedBuilding.count || 0;
                            }
                        });
                    }
                    gameState.news = parsed.news || 0;
                    gameState.bruh = parsed.bruh || 0;
                    gameState.version = defaultGameState.version;
                    
                    // Initialize boost system for migrated saves
                    gameState.boostProgress = parsed.boostProgress || 0;
                    gameState.isBoostActive = parsed.isBoostActive || false;
                    gameState.boostTimeLeft = parsed.boostTimeLeft || 0;
                    gameState.boostCooldown = parsed.boostCooldown || 0;
                    gameState.boostMultiplier = parsed.boostMultiplier || 1;
                    gameState.lastDepletionTime = parsed.lastDepletionTime || Date.now();
                } else {
                    gameState = parsed;
                }
                
                // Ensure we have valid numbers
                gameState.news = Math.max(0, Number(gameState.news) || 0);
                gameState.bruh = Math.max(0, Number(gameState.bruh) || 0);
                gameState.boostProgress = Math.max(0, Number(gameState.boostProgress) || 0);
                gameState.boostTimeLeft = Math.max(0, Number(gameState.boostTimeLeft) || 0);
                gameState.boostCooldown = Math.max(0, Number(gameState.boostCooldown) || 0);
                gameState.boostMultiplier = Math.max(1, Number(gameState.boostMultiplier) || 1);
                gameState.lastDepletionTime = gameState.lastDepletionTime || Date.now();
                
                console.log('Game loaded successfully');
            }
        } catch (e) {
            console.warn('Could not load saved game:', e);
            // Reset to default if corrupted
            gameState = JSON.parse(JSON.stringify(defaultGameState));
        }
    }
    
    // Fixed Game Functions
    function manualClick(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const amount = 1 * getMultiplier();
        gameState.news += amount;
        
        // Increment boost progress
        incrementBoostProgress();
        
        // If boost is active, reset the timer
        if (gameState.isBoostActive) {
            resetBoostTimer();
        }
        
        const btn = document.getElementById('print-btn');
        btn.classList.add('pulse');
        setTimeout(() => btn.classList.remove('pulse'), 300);
        
        // Create floating text
        const floater = document.createElement('div');
        floater.className = 'floater';
        floater.innerText = `üì∞ +${formatNumber(amount)}`;
        
        // Get position
        let x, y;
        if (e.type === 'touchstart' || e.type === 'touchmove') {
            const touch = e.touches[0] || e.changedTouches[0];
            x = touch.clientX;
            y = touch.clientY;
        } else {
            x = e.clientX;
            y = e.clientY;
        }
        
        floater.style.left = `${x}px`;
        floater.style.top = `${y}px`;
        document.body.appendChild(floater);
        
        setTimeout(() => floater.remove(), 1000);
        updateUI();
        saveGame();
    }
    
    function buyMax(id) {
        const building = gameState.buildings[id];
        let bought = 0;
        const maxIterations = 1000;
        
        for (let i = 0; i < maxIterations; i++) {
            let cost = getCost(building);
            if (gameState.news >= cost) {
                gameState.news -= cost;
                building.count++;
                bought++;
            } else {
                break;
            }
        }
        
        if (bought > 0) {
            // Visual feedback
            const card = document.getElementById(`card-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            
            card.style.transform = 'scale(1.02)';
            card.style.backgroundColor = '#e8f5e8';
            card.classList.add('purchased');
            
            setTimeout(() => {
                card.style.transform = '';
                card.style.backgroundColor = '';
            }, 300);
            
            updateUI();
            saveGame();
        }
    }
    
    function prestige() {
        // Calculate how many Bruhs can be bought
        let bruhsToBuy = 0;
        let tempNews = gameState.news;
        let tempBruh = gameState.bruh;
        let totalCost = 0;
        
        // Calculate max affordable Bruhs
        while (true) {
            const nextCost = getPrestigeCost(tempBruh);
            if (tempNews >= nextCost) {
                bruhsToBuy++;
                tempNews -= nextCost;
                tempBruh++;
                totalCost += nextCost;
            } else {
                break;
            }
            if (bruhsToBuy >= 100) break; // Safety limit
        }
        
        if (bruhsToBuy === 0) {
            return;
        }
        
        if (!confirm(`Are you sure? You will lose all News and Assets, but gain ${bruhsToBuy} Bruh${bruhsToBuy > 1 ? 's' : ''} (permanent +${bruhsToBuy * 100}% multiplier).\n\nCurrent Bruh: ${gameState.bruh}\nNew Bruh: ${gameState.bruh + bruhsToBuy}\nTotal Multiplier: x${1 + (gameState.bruh + bruhsToBuy)}`)) {
            return;
        }
        
        // Deduct the total cost and add the Bruhs
        gameState.news -= totalCost;
        gameState.bruh += bruhsToBuy;
        
        // Reset all buildings
        gameState.buildings.forEach(b => b.count = 0);
        
        // Reset boost progress and cooldown (since it's a fresh start)
        gameState.boostProgress = 0;
        gameState.isBoostActive = false;
        gameState.boostTimeLeft = 0;
        gameState.boostCooldown = 0;
        gameState.boostMultiplier = 1;
        gameState.lastDepletionTime = Date.now();
        
        // Hide breaking news banner
        const banner = document.getElementById('breaking-news-banner');
        banner.style.display = 'none';
        
        // Stop emoji rain
        stopEmojiRain();
        
        // Clear boost timer interval
        if (boostTimerInterval) {
            clearInterval(boostTimerInterval);
            boostTimerInterval = null;
        }
        
        // Visual feedback
        const prestigeBox = document.querySelector('.prestige-box');
        prestigeBox.style.backgroundColor = '#ffe6e6';
        prestigeBox.style.transform = 'scale(1.05)';
        
        setTimeout(() => {
            prestigeBox.style.backgroundColor = '';
            prestigeBox.style.transform = '';
        }, 500);
        
        updateUI();
        updateBoostProgress();
        saveGame();
    }
    
    // Fixed UI Update
    function updateUI() {
        // Update stats
        document.getElementById('currency').textContent = formatNumber(gameState.news);
        document.getElementById('cps').textContent = formatNumber(getCPS());
        
        // Show boost multiplier in multiplier display
        if (gameState.isBoostActive) {
            document.getElementById('multiplier').textContent = formatNumber(getMultiplier()) + ' (5x BOOST!)';
            document.getElementById('multiplier').style.color = '#ff0000';
            document.getElementById('multiplier').style.textShadow = '0 0 10px rgba(255, 0, 0, 0.5)';
        } else {
            document.getElementById('multiplier').textContent = formatNumber(getMultiplier());
            document.getElementById('multiplier').style.color = 'var(--red-accent)';
            document.getElementById('multiplier').style.textShadow = 'none';
        }
        
        document.getElementById('bruh-owned').textContent = formatNumber(gameState.bruh);
        document.getElementById('tap-value-display').textContent = `üì∞ +${formatNumber(1 * getMultiplier())} New per Tap`;

        // Update prestige button
        const pBtn = document.getElementById('prestige-btn');
        const prestigeCost = getPrestigeCost(gameState.bruh);
        const prestigeCostElement = document.getElementById('prestige-cost');
        const prestigeMaxElement = document.getElementById('prestige-max');
        
        prestigeCostElement.textContent = `Costs: ${formatNumber(prestigeCost)} New`;
        
        // Calculate max Bruhs that can be bought
        let maxBuy = 0;
        let tempNews = gameState.news;
        let tempBruh = gameState.bruh;
        
        while (true) {
            const nextCost = getPrestigeCost(tempBruh);
            if (tempNews >= nextCost) {
                tempNews -= nextCost;
                tempBruh++;
                maxBuy++;
            } else {
                break;
            }
            if (maxBuy >= 100) break; // Safety limit
        }
        
        prestigeMaxElement.textContent = `Max: ${maxBuy}`;
        
        if (maxBuy > 0) {
            pBtn.disabled = false;
            pBtn.innerHTML = `BUY ${maxBuy} BRUH${maxBuy > 1 ? 'S' : ''} (RESET) <div id="prestige-cost" class="prestige-cost">Costs: ${formatNumber(prestigeCost)} New</div> <div id="prestige-max" class="prestige-max">Max: ${maxBuy}</div>`;
        } else {
            pBtn.disabled = true;
            pBtn.innerHTML = `Need ${formatNumber(prestigeCost)} New <div id="prestige-cost" class="prestige-cost">Costs: ${formatNumber(prestigeCost)} New</div> <div id="prestige-max" class="prestige-max">Max: 0</div>`;
        }

        // Update building cards
        gameState.buildings.forEach(building => {
            const currentCost = getCost(building);
            const maxBuy = getMaxBuy(building);
            const card = document.getElementById(`card-${building.id}`);
            const btn = document.getElementById(`btn-${building.id}`);
            
            if (card) {
                document.getElementById(`count-${building.id}`).textContent = formatNumber(building.count);
                document.getElementById(`cost-text-${building.id}`).textContent = `Cost: ${formatNumber(currentCost)}`;
                
                // Update card classes
                if (building.count > 0) {
                    card.classList.add('purchased');
                } else {
                    card.classList.remove('purchased');
                }
                
                if (maxBuy > 0) {
                    card.classList.remove('disabled');
                    card.classList.add('affordable');
                    btn.disabled = false;
                    btn.classList.add('affordable');
                    document.getElementById(`max-text-${building.id}`).textContent = `Buy ${maxBuy}`;
                    document.getElementById(`max-text-${building.id}`).style.color = "var(--green-accent)";
                } else {
                    card.classList.remove('affordable');
                    card.classList.add('disabled');
                    btn.disabled = true;
                    btn.classList.remove('affordable');
                    document.getElementById(`max-text-${building.id}`).textContent = "Too Expensive";
                    document.getElementById(`max-text-${building.id}`).style.color = "#666";
                }
            }
        });
    }
    
    // Fixed Initialization
    async function init() {
        if (isInitialized) return;
        
        loadGame();
        
        // NEW: Start updating the date/time display
        startDateTimeUpdate();
        
        const container = document.getElementById('upgrades-list');
        container.innerHTML = '';
        
        gameState.buildings.forEach(building => {
            const div = document.createElement('div');
            div.className = 'upgrade-card';
            div.id = `card-${building.id}`;
            
            div.innerHTML = `
                <div class="upgrade-top">
                    <span class="upgrade-name">${building.name}</span>
                    <span class="upgrade-count" id="count-${building.id}">0</span>
                </div>
                <div class="upgrade-info">
                    +${building.baseCPS} CPS (Base)
                </div>
                <button class="upgrade-btn" id="btn-${building.id}" onclick="buyMax(${building.id})">
                    <div class="upgrade-cost" id="cost-text-${building.id}">Cost: 0</div>
                    <div class="upgrade-max" id="max-text-${building.id}">Max: 0</div>
                </button>
            `;
            
            container.appendChild(div);
        });
        
        // Add event listeners
        const printBtn = document.getElementById('print-btn');
        
        // Mouse events
        printBtn.addEventListener('mousedown', manualClick);
        
        // Touch events with proper handling
        printBtn.addEventListener('touchstart', function(e) {
            manualClick(e);
        }, { passive: false });
        
        printBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        // ENHANCED: Boost button is now display-only since it auto-activates
        const boostButton = document.getElementById('boost-button');
        boostButton.addEventListener('click', function() {
            // Do nothing - boost auto-activates at 100%
            // Button is just for display
        });
        
        // NEW: Chat input enter key support
        const chatInput = document.getElementById('chat-input');
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        
        // NEW: Name input enter key support
        const nameInput = document.getElementById('player-name-input');
        nameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startGameWithName();
            }
        });
        
        // Prevent context menu on button
        printBtn.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Initialize offline progress
        const now = Date.now();
        const lastUpdate = gameState.lastUpdate || now;
        const timeDiff = (now - lastUpdate) / 1000; // Convert to seconds
        
        if (timeDiff > 1 && timeDiff < 86400) { // Between 1 second and 24 hours
            const offlineEarnings = getCPS() * timeDiff;
            if (offlineEarnings > 0) {
                gameState.news += offlineEarnings;
                console.log(`Offline earnings: ${formatNumber(offlineEarnings)} New (${Math.floor(timeDiff)} seconds)`);
            }
        }
        
        updateUI();
        updateBoostProgress();
        
        // ENHANCED: If boost was active when saved, reactivate it
        if (gameState.isBoostActive) {
            // Restart the boost timer
            if (boostTimerInterval) clearInterval(boostTimerInterval);
            boostTimerInterval = setInterval(updateBoostTimer, 1000);
            
            // Show enhanced breaking news banner
            const banner = document.getElementById('breaking-news-banner');
            banner.style.display = 'block';
            
            // Start dropping emojis
            startEmojiRain();
            
            // Add visual effect to stats
            const statBlocks = document.querySelectorAll('.stat-block');
            statBlocks.forEach(block => {
                block.classList.add('active-boost');
            });
        }
        
        // ENHANCED: If in cooldown, start cooldown timer
        if (gameState.boostCooldown > 0) {
            const cooldownInterval = setInterval(() => {
                gameState.boostCooldown--;
                updateBoostProgress();
                
                if (gameState.boostCooldown <= 0) {
                    clearInterval(cooldownInterval);
                    gameState.boostCooldown = 0;
                    updateBoostProgress();
                }
            }, 1000);
        }
        
        // NEW: Initialize multiplayer features if connected
        if (isSupabaseConnected) {
            // Update player counts
            updatePlayerCounts();
            
            // Update leaderboard
            updateLeaderboard();
            
            // Update online players
            updateOnlinePlayers();
            
            // Update chat
            updateChatDisplay();
            
            // Set up real-time subscriptions
            setupRealtimeSubscriptions();
            
            // Update player stats immediately
            updatePlayerStats();
        } else {
            // Show offline mode
            document.getElementById('chat-status').textContent = 'Offline';
            document.getElementById('online-count').textContent = '1';
            document.getElementById('total-count').textContent = '1';
            document.getElementById('online-users-count').textContent = '1';
        }
        
        isInitialized = true;
        
        // Start game loops
        startGameLoops();
    }
    
    // Fixed Game Loops
    function startGameLoops() {
        // Update news based on CPS
        function updateNews() {
            const cps = getCPS();
            if (cps > 0) {
                gameState.news += cps * 0.1; // Update 10 times per second
                if (gameState.news < 0) gameState.news = 0;
                if (gameState.news > Number.MAX_SAFE_INTEGER) {
                    // Handle extremely large numbers
                    gameState.news = Number.MAX_SAFE_INTEGER;
                }
            }
        }

        // Main game loop
        function gameLoop() {
            updateNews();
            depleteBoostProgress(); // NEW: Deplete boost over time
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        // Rotate headlines
        function rotateHeadlines() {
            const headlines = [
                "Local cat appointed Editor-in-Chief.",
                "Ink shortage causes panic; citizens using pencil.",
                "Bruh currency value skyrockets over speculation.",
                "Paperboys unionize, demand faster bicycles.",
                "Breaking: Nothing happened today.",
                "Weather forecast: Cloudy with a chance of News.",
                "Typo in front page headline causes minor confusion.",
                "Printing press inventor wins Nobel Prize.",
                "Newspaper sales reach all-time high.",
                "Digital media fails to replace traditional print.",
                "Bruh consultants in high demand worldwide.",
                "Newspaper subscription rates double overnight.",
                "Local economy booms thanks to printing industry.",
                "Ink suppliers report record profits.",
                "Breaking: News consumption at all-time high.",
                "New infinite number system baffles mathematicians.",
                "Alphabetical scaling revolutionizes finance.",
                "Numbers grow beyond traditional notation.",
                "From k to z to aa: The new math frontier.",
                "Infinity now has a proper naming convention."
            ];
            
            const randomHeadline = headlines[Math.floor(Math.random() * headlines.length)];
            const el = document.getElementById('headline-spot');
            
            el.style.opacity = 0;
            setTimeout(() => {
                el.textContent = `"${randomHeadline}"`;
                el.style.opacity = 1;
            }, 500);
        }

        // Auto-save every 30 seconds
        function autoSave() {
            saveGame();
        }

        // NEW: Update multiplayer data periodically
        function updateMultiplayerData() {
            if (!isSupabaseConnected) return;
            
            const now = Date.now();
            if (now - lastPlayerUpdate > 30000) { // Every 30 seconds
                updatePlayerStats();
            }
            
            // Update player counts every 10 seconds
            if (now % 10000 < 100) {
                updatePlayerCounts();
            }
            
            // Update leaderboard every 15 seconds
            if (now - lastLeaderboardUpdate > 15000) {
                updateLeaderboard();
                updateOnlinePlayers();
                lastLeaderboardUpdate = now;
            }
        }

        // Start loops
        gameLoop();
        setInterval(rotateHeadlines, 10000);
        setInterval(autoSave, 30000);
        setInterval(updateMultiplayerData, 1000);
    }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', function() {
        // Check if player already has a name
        const savedName = localStorage.getItem('newsBruhPlayerName');
        if (savedName && savedName.trim() !== '') {
            // Player has a name, hide modal and initialize game
            document.getElementById('name-selection-modal').style.display = 'none';
            document.getElementById('newspaper').style.display = 'flex';
            gameState.playerName = savedName;
            
            // Test Supabase connection
            checkSupabaseConnection().then(connected => {
                isSupabaseConnected = connected;
                init();
            });
        } else {
            // Show name selection modal
            document.getElementById('name-selection-modal').style.display = 'flex';
            document.getElementById('player-name-input').focus();
        }
    });
    
    window.addEventListener('beforeunload', saveGame);
    
    // Export functions to global scope for onclick handlers
    window.manualClick = manualClick;
    window.buyMax = buyMax;
    window.prestige = prestige;
    window.sendChatMessage = sendChatMessage;
    window.startGameWithName = startGameWithName;
    
    // Export the formatting function for debugging
    window.formatNumber = formatNumber;
</script>
</body>
</html>
