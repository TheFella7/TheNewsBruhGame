<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The News Bruh | Tycoon - Online Edition</title>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=UnifrakturMaguntia&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-paper: #f9f7f1; 
            --bg-paper-dark: #e6e4dc;
            --ink: #0a0a0a;
            --ink-light: #454545;
            --red-accent: #cc0000;
            --green-accent: #006400;
            --border: 2px solid #1a1a1a;
            --font-head: 'Playfair Display', serif;
            --font-mono: 'Courier Prime', monospace;
            --font-old-english: 'UnifrakturMaguntia', cursive; 
        }

        /* Authentication Modal Styles */
        #auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: var(--font-mono);
        }

        .auth-container {
            background: var(--bg-paper);
            border: 4px solid var(--ink);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.1);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--ink);
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            font-family: var(--font-mono);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--ink);
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-title {
            font-family: var(--font-head);
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid var(--ink);
            padding-bottom: 10px;
        }

        .auth-input-group {
            margin-bottom: 20px;
        }

        .auth-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--ink);
        }

        .auth-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--ink);
            background: white;
            font-family: var(--font-mono);
            font-size: 1rem;
        }

        .auth-button {
            width: 100%;
            padding: 15px;
            background: var(--ink);
            color: white;
            border: none;
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .auth-button:hover {
            background: #333;
        }

        .auth-button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .auth-error {
            background: #ffcccc;
            color: #cc0000;
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid #cc0000;
            display: none;
        }

        .auth-success {
            background: #ccffcc;
            color: #006400;
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid #006400;
            display: none;
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--ink-light);
        }

        .auth-footer a {
            color: var(--red-accent);
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        .user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--bg-paper);
            border: 2px solid var(--ink);
            padding: 10px 15px;
            z-index: 1000;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.2);
        }

        .user-info span {
            font-weight: bold;
            color: var(--red-accent);
        }

        .logout-btn {
            background: var(--red-accent);
            color: white;
            border: none;
            padding: 5px 10px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Rest of the original CSS styles remain exactly the same */
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #2e2e2e;
            margin: 0;
            padding: 0;
            font-family: var(--font-head);
            color: var(--ink);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            position: relative;
            padding: 10px;
        }

        #newspaper {
            background-color: var(--bg-paper);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            width: 100%;
            max-width: 1400px;
            height: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            position: relative;
        }

        #ticker-tape {
            background: var(--ink);
            color: #ffffff; 
            font-family: var(--font-mono);
            font-size: 0.9rem;
            padding: 6px 0;
            overflow: hidden;
            white-space: nowrap;
            border-bottom: 3px solid var(--ink);
            position: relative;
            width: 100%;
        }
        .ticker-content {
            display: inline-block;
            animation: marquee 25s linear infinite;
            padding-left: 100%;
            white-space: nowrap;
        }
        .ticker-content a {
            color: #4dabf7;
            text-decoration: underline;
            font-weight: bold;
            margin: 0 20px;
        }
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        header {
            text-align: center;
            padding: 15px 20px;
            border-bottom: 5px double var(--ink);
        }
        h1 {
            font-family: var(--font-old-english);
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            margin: 0;
            font-weight: normal;
            line-height: 1;
        }
        
        .player-counts {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--ink-light);
            margin-top: 5px;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .player-counts span {
            font-weight: bold;
        }

        .meta-line {
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--ink);
            border-bottom: 1px solid var(--ink);
            margin-top: 5px;
            padding: 4px 0;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: bold;
            text-transform: uppercase;
            flex-wrap: wrap;
        }
        .meta-line span {
            margin: 0 5px;
        }

        #main-content {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr;
            gap: 0;
            flex: 1;
            min-height: 500px;
        }

        .column {
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #aaa;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 400px;
        }
        .column:last-child { border-right: none; }

        .column::-webkit-scrollbar { width: 8px; }
        .column::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .column::-webkit-scrollbar-track { background: transparent; }

        h2 {
            font-family: var(--font-head);
            border-bottom: 3px double var(--ink);
            margin-top: 0;
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: 900;
            padding-bottom: 5px;
        }

        .stat-block {
            background: rgba(0,0,0,0.02);
            border: 1px solid var(--ink);
            padding: 12px;
            margin-bottom: 15px;
            font-family: var(--font-mono);
            transition: transform 0.2s;
        }
        .stat-block:hover {
            transform: translateY(-2px);
        }
        .stat-label { 
            font-size: 0.9rem; 
            color: var(--ink-light); 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        .stat-value { 
            font-size: 1.6rem; 
            font-weight: bold; 
            color: var(--ink);
        }

        /* Enhanced: Breaking News Banner */
        #breaking-news-container {
            position: relative;
            margin-bottom: 20px;
            min-height: 80px;
        }

        #breaking-news-banner {
            display: none;
            background: linear-gradient(45deg, #cc0000 0%, #ff0000 25%, #cc0000 50%, #ff0000 75%, #cc0000 100%);
            background-size: 400% 400%;
            animation: breakingNewsGradient 3s ease infinite;
            color: #ffffff;
            padding: 12px 20px;
            text-align: center;
            font-family: var(--font-mono);
            font-weight: bold;
            font-size: 1.2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            border: 3px solid #ffcc00;
            border-radius: 0;
            box-shadow: 0 4px 20px rgba(255, 0, 0, 0.4), 
                        inset 0 0 20px rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            transform: perspective(500px) rotateX(5deg);
            transition: all 0.3s ease;
        }

        @keyframes breakingNewsGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #breaking-news-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #ffcc00, transparent);
            animation: scanLine 2s linear infinite;
        }

        @keyframes scanLine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        #breaking-news-banner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(255, 255, 255, 0.1) 2px,
                rgba(255, 255, 255, 0.1) 4px
            );
            pointer-events: none;
        }

        .breaking-news-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            z-index: 2;
        }

        .breaking-news-icon {
            font-size: 1.5rem;
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .breaking-news-title {
            font-size: 1.3rem;
            background: linear-gradient(to bottom, #fff, #ffcc00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        #print-btn {
            background: #ffffff;
            border: 4px solid var(--ink);
            padding: 40px 20px;
            width: 100%;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 6px 6px 0px rgba(0,0,0,0.8);
            touch-action: manipulation;
            user-select: none;
        }
        #print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 8px 8px 0px rgba(0,0,0,0.8);
        }
        #print-btn:active {
            transform: translate(4px, 4px);
            box-shadow: 2px 2px 0px rgba(0,0,0,0.8);
        }
        #print-btn.pulse {
            animation: pulse 0.3s ease;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }
        .print-title {
            font-family: var(--font-head);
            font-size: clamp(1.8rem, 4vw, 2.5rem);
            font-weight: 900;
            display: block;
            text-transform: uppercase;
            line-height: 1.2;
        }
        .print-sub {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            display: block;
            margin-top: 10px;
            color: var(--ink-light);
            font-weight: bold;
        }

        /* Enhanced: Boost System Styles - RED THEME */
        #boost-container {
            margin: 20px 0;
            text-align: center;
        }

        #boost-button {
            width: 100%;
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
            border: 3px solid var(--ink);
            padding: 20px 15px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            font-family: var(--font-mono);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #boost-button:hover:not(:disabled) {
            background: linear-gradient(to bottom, #e8e8e8, #c8c8c8);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #boost-button:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #boost-button:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        #boost-progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ff0000, #ff4444);
            background-size: 200% 100%;
            position: absolute;
            top: 0;
            left: 0;
            transition: width 0.3s;
            z-index: 0;
            animation: progressShimmer 2s infinite linear;
        }

        @keyframes progressShimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .boost-content {
            position: relative;
            z-index: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .boost-percentage {
            font-size: 2rem;
            font-weight: bold;
            color: var(--ink);
            display: block;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .boost-label {
            font-size: 1rem;
            color: var(--ink-light);
            display: block;
            font-weight: bold;
        }

        .boost-timer {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--red-accent);
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 12px;
            border-radius: 20px;
            border: 2px solid var(--red-accent);
            display: none;
            animation: timerPulse 1s infinite alternate;
        }

        @keyframes timerPulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .boost-cooldown {
            font-size: 0.9rem;
            color: var(--red-accent);
            font-weight: bold;
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 10px;
            border-radius: 15px;
            margin-top: 5px;
        }

        /* Falling Emojis */
        .breaking-news-flash {
            position: absolute;
            font-size: 1.8rem;
            animation: fallDown 2s linear forwards;
            pointer-events: none;
            z-index: 100;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            filter: drop-shadow(0 0 3px rgba(255, 204, 0, 0.8));
        }

        @keyframes fallDown {
            0% {
                transform: translateY(-50px) rotate(0deg) scale(1);
                opacity: 1;
            }
            70% { opacity: 1; }
            100% {
                transform: translateY(300px) rotate(360deg) scale(0.5);
                opacity: 0;
            }
        }

        /* Active Boost Indicator */
        .stat-block.active-boost {
            animation: boostGlow 1.5s infinite alternate;
            border-color: var(--red-accent);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
        }

        @keyframes boostGlow {
            from { 
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.4);
                transform: translateY(0);
            }
            to { 
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.8), 0 5px 15px rgba(255, 0, 0, 0.3);
                transform: translateY(-3px);
            }
        }

        #upgrades-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
        }

        .upgrade-card {
            border: 1px solid var(--ink);
            background: #ffffff;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.15);
            transition: all 0.2s ease;
        }
        .upgrade-card.disabled {
            opacity: 0.5;
            background: var(--bg-paper-dark);
            box-shadow: none;
            border: 1px dashed #777;
        }
        .upgrade-card.purchased {
            background: #f0fff0;
            border-color: var(--green-accent);
            box-shadow: 4px 4px 0 rgba(0,100,0,0.2);
        }
        .upgrade-card.affordable {
            animation: glow 1.5s infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 4px 4px 0 rgba(0,100,0,0.2), 0 0 5px rgba(0,100,0,0.3); }
            to { box-shadow: 4px 4px 0 rgba(0,100,0,0.4), 0 0 10px rgba(0,100,0,0.5); }
        }
        .upgrade-top {
            padding: 12px;
            border-bottom: 1px dotted #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .upgrade-name { 
            font-weight: bold; 
            font-size: 1.1rem; 
            font-family: var(--font-head);
        }
        .upgrade-count { 
            font-family: var(--font-mono); 
            font-size: 1.2rem; 
            font-weight: bold;
            color: var(--green-accent);
        }
        
        .upgrade-info {
            padding: 8px 12px;
            font-size: 0.8rem;
            color: var(--ink-light);
            border-bottom: 1px dotted #ccc;
        }
        
        .upgrade-btn {
            width: 100%;
            border: none;
            background: transparent;
            padding: 12px;
            text-align: left;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        .upgrade-btn:hover:not(:disabled) {
            background: #f5f5f5;
        }
        .upgrade-btn:active:not(:disabled) {
            background: #e0e0e0;
        }
        .upgrade-btn:disabled {
            cursor: not-allowed;
            color: #777;
        }
        .upgrade-btn.affordable {
            font-weight: bold;
            color: var(--green-accent);
            background: #f0fff0;
        }
        .upgrade-cost {
            font-weight: bold;
        }
        .upgrade-max {
            font-weight: bold;
        }

        .prestige-box {
            margin-top: auto;
            border: 4px double var(--ink);
            padding: 20px;
            background: var(--bg-paper-dark);
            text-align: center;
        }
        .prestige-btn {
            background: var(--red-accent);
            color: #fff;
            border: none;
            padding: 15px;
            width: 100%;
            font-family: var(--font-head);
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 15px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .prestige-btn:hover:not(:disabled) {
            background: #b30000;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .prestige-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        .prestige-btn:disabled { 
            background: #555; 
            cursor: not-allowed; 
            opacity: 0.5;
        }
        .prestige-cost {
            font-size: 0.9rem;
            font-weight: normal;
            margin-top: 5px;
            color: #ffcccc;
        }
        .prestige-max {
            font-size: 0.8rem;
            font-weight: normal;
            margin-top: 3px;
            color: #aaffaa;
        }

        .floater {
            position: fixed;
            font-family: var(--font-mono), 'Segoe UI Emoji', 'Apple Color Emoji', monospace;
            font-weight: bold;
            color: var(--red-accent);
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 10000;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-size: 1.4rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        @keyframes floatUp {
            0% { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
            70% { opacity: 1; }
            100% { 
                transform: translateY(-100px) scale(1.4); 
                opacity: 0; 
            }
        }

        .headline-box {
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid var(--ink);
            border-bottom: 1px solid var(--ink);
            background: rgba(255,255,255,0.5);
        }
        .headline-box strong {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        #headline-spot {
            font-style: italic;
            font-family: Georgia, serif;
            font-size: 1.1rem;
            line-height: 1.4;
            margin-top: 8px;
            min-height: 60px;
            transition: opacity 0.5s ease;
        }

        /* Leaderboard Styles */
        #leaderboard-section {
            border-top: 5px double var(--ink);
            padding: 20px;
            background: var(--bg-paper-dark);
        }

        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        #leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        #leaderboard-table th {
            background: var(--ink);
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border-right: 1px solid #555;
        }

        #leaderboard-table th:last-child {
            border-right: none;
        }

        #leaderboard-table td {
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }

        #leaderboard-table tr:nth-child(even) {
            background: rgba(0,0,0,0.05);
        }

        #leaderboard-table tr:hover {
            background: rgba(0,0,0,0.1);
        }

        .player-rank {
            font-weight: bold;
            width: 50px;
            text-align: center;
        }

        .rank-1 { color: gold; font-weight: bold; }
        .rank-2 { color: silver; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }

        .player-name {
            font-weight: bold;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-bruh, .player-level {
            text-align: center;
            font-weight: bold;
        }

        /* Chat Styles */
        #chat-section {
            border-top: 5px double var(--ink);
            padding: 20px;
            background: var(--bg-paper);
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            #chat-section {
                grid-template-columns: 1fr;
            }
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 300px;
            border: 2px solid var(--ink);
            background: white;
        }

        .chat-header {
            background: var(--ink);
            color: white;
            padding: 10px;
            font-family: var(--font-mono);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .chat-message {
            padding: 8px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.self {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
            margin-left: 20px;
        }

        .chat-message.other {
            background: #f5f5f5;
            border-left: 3px solid #757575;
            margin-right: 20px;
        }

        .chat-message.tagged {
            background: #fff8e1;
            border-left: 3px solid #ff9800;
            animation: pulseTag 1s ease;
        }

        @keyframes pulseTag {
            0%, 100% { background: #fff8e1; }
            50% { background: #ffecb3; }
        }

        .message-sender {
            font-weight: bold;
            color: var(--ink);
            margin-bottom: 3px;
        }

        .message-timestamp {
            font-size: 0.7rem;
            color: var(--ink-light);
            float: right;
            margin-left: 10px;
        }

        .message-content {
            word-break: break-word;
        }

        .tagged-player {
            background: #ff9800;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
            margin: 0 2px;
        }

        #chat-input-container {
            display: flex;
            border-top: 1px solid #ccc;
        }

        #chat-input {
            flex: 1;
            border: none;
            padding: 12px;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            outline: none;
        }

        #chat-send {
            background: var(--ink);
            color: white;
            border: none;
            padding: 0 20px;
            font-family: var(--font-mono);
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        #chat-send:hover {
            background: #333;
        }

        #chat-send:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .chat-users {
            border: 2px solid var(--ink);
            background: white;
            display: flex;
            flex-direction: column;
        }

        .users-header {
            background: var(--ink);
            color: white;
            padding: 10px;
            font-family: var(--font-mono);
            font-weight: bold;
        }

        #online-users {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .user-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item:hover {
            background: #f5f5f5;
        }

        .user-name {
            font-weight: bold;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-bruh {
            color: var(--green-accent);
            font-weight: bold;
        }

        .user-online {
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .chat-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff9800;
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10002;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 4.7s forwards;
            max-width: 300px;
            cursor: pointer;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .notification-sender {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Hard Reset Button Styles */
        .hard-reset-container {
            text-align: center;
            padding: 20px;
            border-top: 5px double var(--ink);
            background: var(--bg-paper-dark);
        }

        #hard-reset-btn {
            background: linear-gradient(to bottom, #8B0000, #660000);
            color: #ffffff;
            border: 3px solid var(--ink);
            padding: 12px 24px;
            font-family: var(--font-mono);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 0 #330000;
            margin-top: 10px;
        }

        #hard-reset-btn:hover {
            background: linear-gradient(to bottom, #a00000, #770000);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #330000;
        }

        #hard-reset-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 0 #330000;
        }

        .reset-warning {
            font-size: 0.9rem;
            color: var(--red-accent);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .reset-confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .reset-confirmation-box {
            background: var(--bg-paper);
            border: 4px solid var(--red-accent);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.5);
            text-align: center;
            position: relative;
        }

        .reset-confirmation-box h3 {
            font-family: var(--font-head);
            font-size: 1.8rem;
            color: var(--red-accent);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--red-accent);
            padding-bottom: 10px;
        }

        .reset-confirmation-box p {
            font-family: var(--font-mono);
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 25px;
            color: var(--ink);
        }

        .reset-confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .reset-confirm-btn {
            background: linear-gradient(to bottom, #cc0000, #990000);
            color: white;
            border: 2px solid var(--ink);
            padding: 12px 30px;
            font-family: var(--font-mono);
            font-weight: bold;
            cursor: pointer;
            flex: 1;
            transition: all 0.2s;
        }

        .reset-confirm-btn:hover {
            background: linear-gradient(to bottom, #ff0000, #bb0000);
            transform: translateY(-2px);
        }

        .reset-cancel-btn {
            background: linear-gradient(to bottom, #666666, #444444);
            color: white;
            border: 2px solid var(--ink);
            padding: 12px 30px;
            font-family: var(--font-mono);
            font-weight: bold;
            cursor: pointer;
            flex: 1;
            transition: all 0.2s;
        }

        .reset-cancel-btn:hover {
            background: linear-gradient(to bottom, #888888, #666666);
            transform: translateY(-2px);
        }

        .reset-warning-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
            animation: pulseWarning 1.5s infinite;
        }

        @keyframes pulseWarning {
            0%, 100% { transform: scale(1); color: #ff0000; }
            50% { transform: scale(1.1); color: #ff8800; }
        }

        .reset-stats {
            background: rgba(255, 0, 0, 0.1);
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--red-accent);
            text-align: left;
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        .reset-stat-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .reset-stat-label {
            color: var(--ink-light);
        }

        .reset-stat-value {
            color: var(--red-accent);
            font-weight: bold;
        }

        @media (max-width: 1024px) {
            #main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                height: auto;
            }
            
            .column {
                min-height: 300px;
                max-height: 500px;
                border-right: none;
                border-bottom: 2px solid #aaa;
            }
            .column:last-child {
                border-bottom: none;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                overflow-x: hidden;
            }
            
            #newspaper {
                min-height: 100vh;
                height: auto;
            }
            
            .column {
                padding: 15px;
                min-height: auto;
                max-height: none;
                overflow-y: visible;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            #breaking-news-banner {
                font-size: 1rem;
                padding: 10px 15px;
            }
            
            .breaking-news-text {
                flex-direction: column;
                gap: 10px;
            }
            
            .breaking-news-title {
                font-size: 1.1rem;
            }
            
            #print-btn {
                padding: 30px 15px;
            }
            
            .print-title {
                font-size: 1.8rem;
            }
            
            .meta-line {
                font-size: 0.75rem;
            }
            
            .player-counts {
                font-size: 0.7rem;
            }
            
            .stat-value {
                font-size: 1.4rem;
            }
            
            .prestige-box {
                padding: 15px;
            }

            #leaderboard-section,
            #chat-section {
                padding: 15px;
            }

            .chat-container,
            .chat-users {
                height: 250px;
            }

            #chat-section {
                grid-template-columns: 1fr;
            }
            
            #boost-button {
                padding: 15px 10px;
                min-height: 80px;
            }
            
            .boost-percentage {
                font-size: 1.6rem;
            }
            
            .boost-label {
                font-size: 0.9rem;
            }

            .user-info {
                position: static;
                margin: 10px auto;
                width: 90%;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            #print-btn {
                padding: 25px 10px;
            }
            
            .print-title {
                font-size: 1.5rem;
            }
            
            .column {
                padding: 10px;
            }

            #breaking-news-banner {
                font-size: 0.9rem;
                padding: 8px 10px;
            }
            
            .breaking-news-title {
                font-size: 1rem;
            }
            
            #leaderboard-table th,
            #leaderboard-table td {
                padding: 8px 5px;
                font-size: 0.8rem;
            }

            .player-name {
                max-width: 80px;
            }
            
            #boost-button {
                padding: 12px 8px;
                min-height: 70px;
            }
            
            .boost-percentage {
                font-size: 1.4rem;
            }
            
            .boost-label {
                font-size: 0.8rem;
            }

            .auth-container {
                padding: 20px;
            }
            
            .auth-tab {
                padding: 10px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>

<!-- User Info Display -->
<div id="user-info" class="user-info" style="display: none;">
    Logged in as: <span id="display-username">Loading...</span>
    <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<!-- Authentication Modal -->
<div id="auth-modal">
    <div class="auth-container">
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('register')">Register</button>
            <button class="auth-tab" onclick="switchAuthTab('login')">Login</button>
            <button class="auth-tab" onclick="switchAuthTab('reset')">Reset Password</button>
        </div>

        <!-- Error/Success Messages -->
        <div id="auth-error" class="auth-error"></div>
        <div id="auth-success" class="auth-success"></div>

        <!-- Registration Form -->
        <div id="register-form" class="auth-form active">
            <div class="auth-title">Create Account</div>
            <div class="auth-input-group">
                <label for="register-email">Email Address</label>
                <input type="email" id="register-email" class="auth-input" placeholder="your.email@example.com">
            </div>
            <div class="auth-input-group">
                <label for="register-username">Username</label>
                <input type="text" id="register-username" class="auth-input" placeholder="Choose a username">
            </div>
            <div class="auth-input-group">
                <label for="register-password">Password</label>
                <input type="password" id="register-password" class="auth-input" placeholder="Minimum 6 characters">
            </div>
            <div class="auth-input-group">
                <label for="register-confirm-password">Confirm Password</label>
                <input type="password" id="register-confirm-password" class="auth-input" placeholder="Repeat your password">
            </div>
            <button class="auth-button" onclick="register()">Create Account & Start Playing</button>
            <div class="auth-footer">
                Already have an account? <a onclick="switchAuthTab('login')">Login here</a>
            </div>
        </div>

        <!-- Login Form -->
        <div id="login-form" class="auth-form">
            <div class="auth-title">Welcome Back</div>
            <div class="auth-input-group">
                <label for="login-email">Email Address</label>
                <input type="email" id="login-email" class="auth-input" placeholder="your.email@example.com">
            </div>
            <div class="auth-input-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" class="auth-input" placeholder="Your password">
            </div>
            <button class="auth-button" onclick="login()">Login to Your Account</button>
            <div class="auth-footer">
                New player? <a onclick="switchAuthTab('register')">Register here</a> â€¢ 
                <a onclick="switchAuthTab('reset')">Forgot password?</a>
            </div>
        </div>

        <!-- Password Reset Form -->
        <div id="reset-form" class="auth-form">
            <div class="auth-title">Reset Password</div>
            <div class="auth-input-group">
                <label for="reset-email">Email Address</label>
                <input type="email" id="reset-email" class="auth-input" placeholder="your.email@example.com">
            </div>
            <button class="auth-button" onclick="resetPassword()">Send Reset Link</button>
            <div class="auth-footer">
                Remember your password? <a onclick="switchAuthTab('login')">Login here</a>
            </div>
        </div>
    </div>
</div>

<div id="newspaper">
    <div id="ticker-tape">
        <div class="ticker-content" id="ticker-text">
            Join <a href="https://www.reddit.com/r/thenewsbruh/s/HPIdtW6H3X" target="_blank">r/TheNewsBruh</a> on Reddit & Reach The Top 3 on The Leaderboard to Earn Real New Token &nbsp;&bull;&nbsp; EXTRA! EXTRA! &nbsp;&bull;&nbsp; NEW: Online Multiplayer Edition!
        </div>
    </div>

    <header>
        <h1>The News Bruh</h1>
        
        <div class="player-counts">
            <span>Players Online: <span id="online-count">12,403</span></span>
            <span>Total Players: <span id="total-count">842,019</span></span>
            <span>Your Rank: <span id="player-rank">#--</span></span>
        </div>

        <div class="meta-line">
            <span>Vol. 2</span>
            <span>Online Edition</span>
            <span id="currentDateTime">Loading...</span>
        </div>
    </header>

    <div id="main-content">
        
        <div class="column" id="col-left">
            <h2>Statistics</h2>
            
            <div class="stat-block">
                <div class="stat-label">Treasury</div>
                <div class="stat-value"><span id="currency">0</span> New</div>
            </div>

            <div class="stat-block">
                <div class="stat-label">Production</div>
                <div class="stat-value"><span id="cps">0.0</span> / sec</div>
            </div>

            <div class="stat-block">
                <div class="stat-label">Market Multiplier</div>
                <div class="stat-value" style="color: var(--red-accent);">x<span id="multiplier">1</span></div>
            </div>

            <div class="prestige-box">
                <h3 style="margin:0 0 10px 0; border-bottom: 1px solid var(--ink);">THE CLASSIFIEDS</h3>
                <p style="font-size: 0.85rem; margin-bottom: 10px; line-height: 1.4;">
                    Hire a <strong>Bruh</strong> Consultant. Each Bruh owned adds a <strong>+100% (x1)</strong> permanent bonus to all production.
                </p>
                <div style="font-weight: bold; margin-bottom: 5px; font-size: 1.1rem;">Bruh Owned: <span id="bruh-owned">0</span></div>
                <button id="prestige-btn" class="prestige-btn" onclick="prestige()">
                    Buy Bruh
                    <div id="prestige-cost" class="prestige-cost">Costs: 1k New</div>
                    <div id="prestige-max" class="prestige-max">Max: 0</div>
                </button>
            </div>
        </div>

        <div class="column" id="col-center">
            <h2>Front Page</h2>
            
            <!-- Enhanced: Breaking News Banner -->
            <div id="breaking-news-container">
                <div id="breaking-news-banner">
                    <div class="breaking-news-text">
                        <span class="breaking-news-icon">ðŸ“°</span>
                        <span class="breaking-news-title">BREAKING NEWS: 5X MULTIPLIER ACTIVE!</span>
                    </div>
                </div>
            </div>
            
            <button id="print-btn">
                <span class="print-title">PRINT EDITION</span>
                <span class="print-sub" id="tap-value-display">ðŸ“° +1 New per Tap</span>
            </button>

            <!-- Enhanced: Boost Button -->
            <div id="boost-container">
                <button id="boost-button">
                    <div id="boost-progress-bar"></div>
                    <div class="boost-content">
                        <span class="boost-percentage" id="boost-percentage">0%</span>
                        <span class="boost-label">BREAKING NEWS BOOST</span>
                        <span class="boost-timer" id="boost-timer">15s</span>
                        <span class="boost-cooldown" id="boost-cooldown"></span>
                    </div>
                </button>
            </div>

            <div class="headline-box">
                <strong>Latest Headline:</strong>
                <p id="headline-spot">
                    "Local entrepreneur starts printing press in garage, neighbors concerned about noise."
                </p>
            </div>

            <div style="text-align: center; margin-top: 20px; opacity: 0.6;">
                <div style="font-family: var(--font-mono); font-size: 0.8rem; margin-bottom: 10px;">ADVERTISEMENT</div>
                <div style="width: 100px; height: 100px; background: var(--bg-paper-dark); border: 2px solid var(--ink); margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-family: var(--font-mono);">
                    PRESS<br>HERE
                </div>
            </div>
        </div>

        <div class="column" id="col-right">
            <h2>Assets</h2>
            <div id="upgrades-list">
                <!-- Upgrades will be dynamically inserted here -->
            </div>
        </div>

    </div>

    <!-- Leaderboard Section -->
    <div id="leaderboard-section">
        <div class="leaderboard-header">
            <h2 style="border-bottom: none; margin: 0;">ðŸ† Global Leaderboard ðŸ†</h2>
            <div id="leaderboard-update-time" style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--ink-light);">
                Updated: Just now
            </div>
        </div>
        <table id="leaderboard-table">
            <thead>
                <tr>
                    <th style="width: 60px;">RANK</th>
                    <th>PLAYER</th>
                    <th style="width: 120px;">BRUH COUNT</th>
                    <th style="width: 100px;">LEVEL</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                <!-- Leaderboard rows will be inserted here -->
            </tbody>
        </table>
    </div>

    <!-- Chat Section -->
    <div id="chat-section">
        <div class="chat-container">
            <div class="chat-header">
                <span>ðŸ“° PRESS ROOM CHAT</span>
                <span id="chat-status">Connected</span>
            </div>
            <div id="chat-messages">
                <!-- Chat messages will be inserted here -->
                <div class="chat-message other">
                    <div class="message-sender">System <span class="message-timestamp">Just now</span></div>
                    <div class="message-content">Welcome to The News Bruh Online Edition! Chat with players worldwide.</div>
                </div>
            </div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Type your message... (Use @name to tag players)" maxlength="200">
                <button id="chat-send" onclick="sendChatMessage()">SEND</button>
            </div>
        </div>
        
        <div class="chat-users">
            <div class="users-header">
                <span>ðŸŸ¢ ONLINE PLAYERS (<span id="online-users-count">1</span>)</span>
            </div>
            <div id="online-users">
                <!-- Online users will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Hard Reset Button Section -->
    <div class="hard-reset-container">
        <div class="reset-warning">âš ï¸ CAUTION: IRREVERSIBLE ACTION</div>
        <button id="hard-reset-btn" onclick="showResetConfirmation()">
            ðŸ—‘ï¸ HARD RESET GAME
        </button>
        <div style="font-size: 0.8rem; color: var(--ink-light); margin-top: 8px;">
            This will delete ALL progress, chat, and leaderboard data
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-confirmation-modal" class="reset-confirmation-modal">
        <div class="reset-confirmation-box">
            <span class="reset-warning-icon">âš ï¸</span>
            <h3>CONFIRM HARD RESET</h3>
            <p>Are you absolutely sure you want to reset EVERYTHING? This action cannot be undone!</p>
            
            <div class="reset-stats">
                <div class="reset-stat-item">
                    <span class="reset-stat-label">Current Bruh:</span>
                    <span class="reset-stat-value" id="reset-current-bruh">0</span>
                </div>
                <div class="reset-stat-item">
                    <span class="reset-stat-label">Current News:</span>
                    <span class="reset-stat-value" id="reset-current-news">0</span>
                </div>
                <div class="reset-stat-item">
                    <span class="reset-stat-label">Buildings Owned:</span>
                    <span class="reset-stat-value" id="reset-buildings-count">0</span>
                </div>
                <div class="reset-stat-item">
                    <span class="reset-stat-label">Chat Messages:</span>
                    <span class="reset-stat-value" id="reset-chat-count">0</span>
                </div>
            </div>
            
            <div class="reset-confirmation-buttons">
                <button class="reset-cancel-btn" onclick="hideResetConfirmation()">
                    CANCEL - KEEP MY PROGRESS
                </button>
                <button class="reset-confirm-btn" onclick="performHardReset()">
                    YES, DELETE EVERYTHING
                </button>
            </div>
        </div>
    </div>
</div> <!-- Closing div for #newspaper -->

<!-- Chat Notification -->
<div id="chat-notification" class="chat-notification" style="display: none;">
    <div class="notification-sender" id="notification-sender"></div>
    <div class="notification-message" id="notification-message"></div>
</div>

<script>
    // Supabase Configuration (using your provided credentials)
    const SUPABASE_URL = 'https://qlwtovkrmfoqfgrtynrv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsd3RvdmtybWZvcWZncnR5bnJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNzE4NTksImV4cCI6MjA4Mzg0Nzg1OX0.XMPhSftpLtTeM3gTS0Acf6DrFuI_H0U-iAfxAas9n8Y';

    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Authentication State
    let currentUser = null;
    let isAuthenticated = false;
    let authCheckComplete = false;

    // Game State Management
    const defaultGameState = {
        news: 0,
        bruh: 0,
        buildings: [
            { id: 0, name: "Paperboy", baseCost: 15, baseCPS: 0.5, count: 0 },
            { id: 1, name: "Editor", baseCost: 100, baseCPS: 4, count: 0 },
            { id: 2, name: "Printing Press", baseCost: 1100, baseCPS: 12, count: 0 },
            { id: 3, name: "Distribution Van", baseCost: 12000, baseCPS: 45, count: 0 },
            { id: 4, name: "News Tower", baseCost: 130000, baseCPS: 160, count: 0 },
            { id: 5, name: "Media Empire", baseCost: 1400000, baseCPS: 850, count: 0 }
        ],
        lastUpdate: Date.now(),
        version: "2.0.0", // Updated version for online edition
        playerName: "",
        chatNotifications: true,
        // Enhanced: Boost System State
        boostProgress: 0,
        isBoostActive: false,
        boostTimeLeft: 0,
        boostCooldown: 0,
        boostMultiplier: 1,
        lastDepletionTime: Date.now()
    };

    let gameState = JSON.parse(JSON.stringify(defaultGameState));
    let isInitialized = false;
    
    // Enhanced: Boost system variables
    let breakingNewsEmojis = [];
    let boostEmojiInterval = null;
    let boostTimerInterval = null;

    // Chat System Variables
    let chatMessages = [];
    let onlinePlayers = [];
    let leaderboardData = [];
    let lastChatUpdate = 0;
    let lastLeaderboardUpdate = 0;

    // Live Date & Time Display
    function updateDateTime() {
        const now = new Date();
        
        // Format day with leading zero
        const day = String(now.getDate()).padStart(2, '0');
        
        // Format month with leading zero (months are 0-indexed in JavaScript)
        const month = String(now.getMonth() + 1).padStart(2, '0');
        
        // Get full year
        const year = now.getFullYear();
        
        // Format time with leading zeros
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        
        // Create the formatted string: dd/mm/yyyy HH:MM:SS
        const dateTimeString = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        
        // Update the element
        const dateTimeElement = document.getElementById('currentDateTime');
        if (dateTimeElement) {
            dateTimeElement.textContent = dateTimeString;
        }
    }

    // Start updating the date/time every second
    function startDateTimeUpdate() {
        // Update immediately
        updateDateTime();
        
        // Then update every second
        setInterval(updateDateTime, 1000);
    }

    // Authentication Functions
    async function checkAuth() {
        try {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error) throw error;
            
            if (session?.user) {
                currentUser = session.user;
                isAuthenticated = true;
                
                // Get user profile from database
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('username, game_state')
                    .eq('id', currentUser.id)
                    .single();
                
                if (profileError && profileError.code !== 'PGRST116') {
                    console.warn('Profile error:', profileError);
                }
                
                if (profile) {
                    gameState.playerName = profile.username;
                    
                    // Load game state from database
                    if (profile.game_state) {
                        try {
                            const savedState = JSON.parse(profile.game_state);
                            if (savedState && savedState.version === gameState.version) {
                                gameState = { ...gameState, ...savedState };
                                gameState.playerName = profile.username; // Keep the username
                            }
                        } catch (e) {
                            console.warn('Error parsing saved game state:', e);
                        }
                    }
                }
                
                updateUserInfo();
                hideAuthModal();
                initGame();
            } else {
                showAuthModal();
            }
        } catch (error) {
            console.error('Auth check error:', error);
            showAuthModal();
        } finally {
            authCheckComplete = true;
        }
    }

    async function register() {
        const email = document.getElementById('register-email').value;
        const username = document.getElementById('register-username').value;
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('register-confirm-password').value;
        
        // Validation
        if (!email || !username || !password) {
            showAuthError('Please fill in all fields');
            return;
        }
        
        if (password.length < 6) {
            showAuthError('Password must be at least 6 characters');
            return;
        }
        
        if (password !== confirmPassword) {
            showAuthError('Passwords do not match');
            return;
        }
        
        if (username.length < 3 || username.length > 20) {
            showAuthError('Username must be between 3 and 20 characters');
            return;
        }
        
        // Check if username is available
        const { data: existingUser, error: checkError } = await supabase
            .from('profiles')
            .select('username')
            .eq('username', username)
            .single();
        
        if (existingUser) {
            showAuthError('Username already taken');
            return;
        }
        
        // Disable button and show loading
        const button = document.querySelector('#register-form .auth-button');
        const originalText = button.textContent;
        button.textContent = 'Creating account...';
        button.disabled = true;
        
        try {
            // Create auth user
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        username: username
                    }
                }
            });
            
            if (authError) throw authError;
            
            // Create user profile
            const { error: profileError } = await supabase
                .from('profiles')
                .insert([
                    {
                        id: authData.user.id,
                        email: email,
                        username: username,
                        created_at: new Date().toISOString(),
                        game_state: JSON.stringify(gameState)
                    }
                ]);
            
            if (profileError) throw profileError;
            
            showAuthSuccess('Account created successfully! Please check your email to confirm your account.');
            
            // Switch to login form
            setTimeout(() => {
                switchAuthTab('login');
                document.getElementById('login-email').value = email;
                document.getElementById('login-password').value = password;
            }, 2000);
            
        } catch (error) {
            console.error('Registration error:', error);
            showAuthError(error.message || 'Registration failed. Please try again.');
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        if (!email || !password) {
            showAuthError('Please fill in all fields');
            return;
        }
        
        // Disable button and show loading
        const button = document.querySelector('#login-form .auth-button');
        const originalText = button.textContent;
        button.textContent = 'Logging in...';
        button.disabled = true;
        
        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) throw error;
            
            currentUser = data.user;
            isAuthenticated = true;
            
            // Get user profile
            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('username, game_state')
                .eq('id', currentUser.id)
                .single();
            
            if (profileError) throw profileError;
            
            gameState.playerName = profile.username;
            
            // Load game state from database
            if (profile.game_state) {
                try {
                    const savedState = JSON.parse(profile.game_state);
                    if (savedState && savedState.version === gameState.version) {
                        gameState = { ...gameState, ...savedState };
                        gameState.playerName = profile.username;
                    }
                } catch (e) {
                    console.warn('Error parsing saved game state:', e);
                }
            }
            
            showAuthSuccess('Login successful! Loading your game...');
            
            setTimeout(() => {
                updateUserInfo();
                hideAuthModal();
                initGame();
            }, 1000);
            
        } catch (error) {
            console.error('Login error:', error);
            showAuthError('Invalid email or password. Please try again.');
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    async function resetPassword() {
        const email = document.getElementById('reset-email').value;
        
        if (!email) {
            showAuthError('Please enter your email address');
            return;
        }
        
        // Disable button and show loading
        const button = document.querySelector('#reset-form .auth-button');
        const originalText = button.textContent;
        button.textContent = 'Sending...';
        button.disabled = true;
        
        try {
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + '/reset-password.html',
            });
            
            if (error) throw error;
            
            showAuthSuccess('Password reset link sent! Check your email.');
            
        } catch (error) {
            console.error('Reset password error:', error);
            showAuthError('Failed to send reset link. Please try again.');
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    async function logout() {
        try {
            const { error } = await supabase.auth.signOut();
            if (error) throw error;
            
            currentUser = null;
            isAuthenticated = false;
            
            // Reset game state
            gameState = JSON.parse(JSON.stringify(defaultGameState));
            
            // Hide user info and show auth modal
            document.getElementById('user-info').style.display = 'none';
            showAuthModal();
            
        } catch (error) {
            console.error('Logout error:', error);
        }
    }

    function updateUserInfo() {
        const userInfo = document.getElementById('user-info');
        const displayUsername = document.getElementById('display-username');
        
        if (currentUser && gameState.playerName) {
            displayUsername.textContent = gameState.playerName;
            userInfo.style.display = 'block';
        }
    }

    function switchAuthTab(tab) {
        // Update tabs
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
        
        // Activate selected tab
        document.querySelector(`.auth-tab[onclick*="${tab}"]`).classList.add('active');
        document.getElementById(`${tab}-form`).classList.add('active');
        
        // Clear messages
        document.getElementById('auth-error').style.display = 'none';
        document.getElementById('auth-success').style.display = 'none';
    }

    function showAuthError(message) {
        const errorDiv = document.getElementById('auth-error');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('auth-success').style.display = 'none';
    }

    function showAuthSuccess(message) {
        const successDiv = document.getElementById('auth-success');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        document.getElementById('auth-error').style.display = 'none';
    }

    function showAuthModal() {
        document.getElementById('auth-modal').style.display = 'flex';
    }

    function hideAuthModal() {
        document.getElementById('auth-modal').style.display = 'none';
    }

    // Game Functions (Keep all original game functions exactly as they were)
    // INFINITE ALPHABETICAL NUMBER SYSTEM
    function formatNumber(num) {
        if (typeof num !== 'number' || !isFinite(num)) return '0';
        if (num < 0) return '-' + formatNumber(-num);
        if (num < 1000) return Math.floor(num).toLocaleString();
        
        // Convert to infinite alphabetical system
        return toAlphabetical(num);
    }

    function toAlphabetical(num) {
        if (num >= 1e6) {
            const log = Math.log10(num);
            const magnitude = Math.floor(log / 3);
            
            if (magnitude < 1) return Math.floor(num).toLocaleString();
            
            const baseValue = Math.pow(1000, magnitude);
            const scaled = num / baseValue;
            const suffix = getAlphabeticalSuffix(magnitude - 1);
            
            if (scaled >= 100) {
                return Math.floor(scaled) + suffix;
            } else if (scaled >= 10) {
                return scaled.toFixed(1) + suffix;
            } else {
                return scaled.toFixed(2) + suffix;
            }
        }
        
        if (num >= 1e15) return (num / 1e15).toFixed(2) + "Qa";
        if (num >= 1e12) return (num / 1e12).toFixed(2) + "T";
        if (num >= 1e9) return (num / 1e9).toFixed(2) + "B";
        if (num >= 1e6) return (num / 1e6).toFixed(2) + "M";
        if (num >= 1e3) return (num / 1e3).toFixed(1) + "k";
        
        return Math.floor(num).toLocaleString();
    }

    function getAlphabeticalSuffix(index) {
        if (index < 0) return "";
        
        if (index < 26) {
            return String.fromCharCode(97 + index);
        }
        
        let result = "";
        let remaining = index;
        
        while (remaining >= 0) {
            const charIndex = remaining % 26;
            result = String.fromCharCode(97 + charIndex) + result;
            
            remaining = Math.floor(remaining / 26) - 1;
            
            if (remaining < 0) break;
        }
        
        return result;
    }

    // ENHANCED: Boost System Functions
    function updateBoostProgress() {
        const boostButton = document.getElementById('boost-button');
        const progressBar = document.getElementById('boost-progress-bar');
        const percentageElement = document.getElementById('boost-percentage');
        const cooldownElement = document.getElementById('boost-cooldown');
        const timerElement = document.getElementById('boost-timer');
        
        if (gameState.boostCooldown > 0) {
            boostButton.disabled = true;
            const minutes = Math.floor(gameState.boostCooldown / 60);
            const seconds = Math.floor(gameState.boostCooldown % 60);
            cooldownElement.textContent = `Cooldown: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            cooldownElement.style.display = 'block';
            timerElement.style.display = 'none';
            percentageElement.textContent = '0%';
            progressBar.style.width = '0%';
            progressBar.style.background = 'linear-gradient(90deg, #cccccc, #999999)';
        } else if (gameState.isBoostActive) {
            boostButton.disabled = false;
            percentageElement.textContent = 'ACTIVE!';
            percentageElement.style.color = '#ff0000';
            percentageElement.style.textShadow = '0 0 10px rgba(255, 0, 0, 0.8)';
            progressBar.style.width = '100%';
            progressBar.style.background = 'linear-gradient(90deg, #ff0000, #ff8800, #ff0000)';
            progressBar.style.animation = 'progressShimmer 1s infinite linear';
            cooldownElement.style.display = 'none';
            timerElement.style.display = 'block';
            timerElement.textContent = `${gameState.boostTimeLeft}s`;
        } else {
            boostButton.disabled = false;
            percentageElement.style.color = '';
            percentageElement.style.textShadow = '';
            percentageElement.textContent = `${Math.floor(gameState.boostProgress)}%`;
            progressBar.style.width = `${gameState.boostProgress}%`;
            progressBar.style.background = 'linear-gradient(90deg, #ff4444, #ff0000, #ff4444)';
            progressBar.style.animation = 'progressShimmer 2s infinite linear';
            cooldownElement.style.display = 'none';
            timerElement.style.display = 'none';
            
            if (gameState.boostProgress >= 100) {
                cooldownElement.textContent = 'READY!';
                cooldownElement.style.display = 'block';
                cooldownElement.style.color = '#ff0000';
                cooldownElement.style.background = 'rgba(255, 0, 0, 0.2)';
            } else {
                cooldownElement.style.display = 'none';
            }
        }
    }

    function depleteBoostProgress() {
        if (gameState.isBoostActive || gameState.boostCooldown > 0 || gameState.boostProgress <= 0) {
            return;
        }
        
        const now = Date.now();
        const timeSinceLastDepletion = (now - gameState.lastDepletionTime) / 1000;
        
        if (timeSinceLastDepletion >= 1) {
            gameState.boostProgress = Math.max(0, gameState.boostProgress - 2);
            gameState.lastDepletionTime = now;
            
            if (gameState.boostProgress % 10 === 0 || gameState.boostProgress <= 1) {
                updateBoostProgress();
            }
        }
    }

    function incrementBoostProgress() {
        if (gameState.isBoostActive || gameState.boostCooldown > 0) {
            return;
        }
        
        gameState.boostProgress += 5;
        gameState.lastDepletionTime = Date.now();
        
        if (gameState.boostProgress >= 100) {
            gameState.boostProgress = 100;
            activateBoost();
        }
        
        updateBoostProgress();
        saveGame();
    }

    function activateBoost() {
        if (gameState.isBoostActive || gameState.boostProgress < 100) return;
        
        gameState.isBoostActive = true;
        gameState.boostTimeLeft = 15;
        gameState.boostMultiplier = 5;
        gameState.boostProgress = 0;
        
        const banner = document.getElementById('breaking-news-banner');
        banner.style.display = 'block';
        
        startEmojiRain();
        
        updateBoostTimer();
        
        if (boostTimerInterval) clearInterval(boostTimerInterval);
        boostTimerInterval = setInterval(updateBoostTimer, 1000);
        
        const statBlocks = document.querySelectorAll('.stat-block');
        statBlocks.forEach(block => {
            block.classList.add('active-boost');
        });
        
        updateUI();
        updateBoostProgress();
        
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } catch (e) {}
    }

    function updateBoostTimer() {
        if (!gameState.isBoostActive) return;
        
        gameState.boostTimeLeft--;
        
        const timerElement = document.getElementById('boost-timer');
        
        if (timerElement) {
            timerElement.textContent = `${gameState.boostTimeLeft}s`;
            
            if (gameState.boostTimeLeft <= 5) {
                timerElement.style.animation = 'none';
                setTimeout(() => {
                    timerElement.style.animation = 'pulseTimer 0.5s infinite alternate';
                }, 10);
                timerElement.style.color = '#ff0000';
                timerElement.style.borderColor = '#ff0000';
            }
        }
        
        if (gameState.boostTimeLeft <= 0) {
            endBoost();
        }
    }

    function resetBoostTimer() {
        if (!gameState.isBoostActive) return;
        
        gameState.boostTimeLeft = 15;
        
        const timerElement = document.getElementById('boost-timer');
        
        if (timerElement) {
            timerElement.textContent = `${gameState.boostTimeLeft}s`;
            timerElement.style.color = '#ff0000';
            timerElement.style.borderColor = '#ff0000';
        }
        
        const banner = document.getElementById('breaking-news-banner');
        banner.style.transform = 'perspective(500px) rotateX(5deg) scale(1.05)';
        banner.style.boxShadow = '0 6px 25px rgba(255, 0, 0, 0.6), inset 0 0 25px rgba(255, 255, 255, 0.4)';
        
        setTimeout(() => {
            banner.style.transform = 'perspective(500px) rotateX(5deg)';
            banner.style.boxShadow = '0 4px 20px rgba(255, 0, 0, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.3)';
        }, 300);
    }

    function endBoost() {
        gameState.isBoostActive = false;
        gameState.boostMultiplier = 1;
        gameState.boostCooldown = 600;
        
        const banner = document.getElementById('breaking-news-banner');
        banner.style.display = 'none';
        
        stopEmojiRain();
        
        if (boostTimerInterval) {
            clearInterval(boostTimerInterval);
            boostTimerInterval = null;
        }
        
        const statBlocks = document.querySelectorAll('.stat-block');
        statBlocks.forEach(block => {
            block.classList.remove('active-boost');
        });
        
        const cooldownInterval = setInterval(() => {
            gameState.boostCooldown--;
            updateBoostProgress();
            
            if (gameState.boostCooldown <= 0) {
                clearInterval(cooldownInterval);
                gameState.boostCooldown = 0;
                updateBoostProgress();
            }
        }, 1000);
        
        updateUI();
        updateBoostProgress();
    }

    function startEmojiRain() {
        if (boostEmojiInterval) clearInterval(boostEmojiInterval);
        
        boostEmojiInterval = setInterval(() => {
            createFallingEmoji();
            if (Math.random() > 0.5) {
                setTimeout(createFallingEmoji, 150);
            }
        }, 300);
    }

    function stopEmojiRain() {
        if (boostEmojiInterval) {
            clearInterval(boostEmojiInterval);
            boostEmojiInterval = null;
        }
        
        breakingNewsEmojis.forEach(emoji => {
            if (emoji.parentNode) {
                emoji.parentNode.removeChild(emoji);
            }
        });
        breakingNewsEmojis = [];
    }

    function createFallingEmoji() {
        const banner = document.getElementById('breaking-news-container');
        if (!banner) return;
        
        const emoji = document.createElement('div');
        emoji.className = 'breaking-news-flash';
        emoji.textContent = 'ðŸ“°';
        
        const newspaper = document.getElementById('newspaper');
        const newspaperRect = newspaper.getBoundingClientRect();
        const bannerRect = banner.getBoundingClientRect();
        
        const startX = Math.random() * newspaperRect.width;
        const startY = bannerRect.top - newspaperRect.top;
        
        emoji.style.left = `${startX}px`;
        emoji.style.top = `${startY}px`;
        emoji.style.fontSize = `${Math.random() * 20 + 20}px`;
        emoji.style.animationDuration = `${Math.random() * 1 + 1.5}s`;
        
        emoji.style.transform = `rotate(${Math.random() > 0.5 ? '' : '-'}${Math.random() * 30}deg)`;
        
        newspaper.appendChild(emoji);
        breakingNewsEmojis.push(emoji);
        
        setTimeout(() => {
            if (emoji.parentNode) {
                emoji.parentNode.removeChild(emoji);
                const index = breakingNewsEmojis.indexOf(emoji);
                if (index > -1) {
                    breakingNewsEmojis.splice(index, 1);
                }
            }
        }, 2000);
    }

    const getPrestigeCost = (bruhCount) => {
        return Math.floor(1000 * Math.pow(2.5, bruhCount));
    };

    const getMultiplier = () => {
        const bruh = gameState.bruh || 0;
        if (bruh > 1e12) {
            return (1 + Math.pow(Math.log10(bruh + 1), 2)) * gameState.boostMultiplier;
        }
        return (1 + bruh) * gameState.boostMultiplier;
    };

    const getCost = (building) => {
        const count = building.count || 0;
        const baseCost = building.baseCost || 15;
        
        if (count > 1000) {
            const exponent = Math.min(count, 10000) * 0.15;
            return Math.floor(baseCost * Math.pow(1.15, Math.min(exponent, 100)));
        }
        
        return Math.floor(baseCost * Math.pow(1.15, count));
    };

    const getCPS = () => {
        let base = gameState.buildings.reduce((acc, b) => acc + (b.count * b.baseCPS), 0);
        return base * getMultiplier();
    };

    const getMaxBuy = (building) => {
        let canBuy = 0;
        let tempNews = gameState.news;
        let tempCount = building.count;
        
        const maxIterations = 1000;
        
        for (let i = 0; i < maxIterations; i++) {
            let nextCost = getCost({...building, count: tempCount});
            if (tempNews >= nextCost) {
                canBuy++;
                tempNews -= nextCost;
                tempCount++;
            } else {
                break;
            }
        }
        
        return canBuy;
    };

    const calculateLevel = (bruh, news) => {
        return Math.floor(Math.sqrt(bruh * 10 + news / 1000));
    };

    // NEW: Database Save Function
    async function saveGame() {
        try {
            gameState.lastUpdate = Date.now();
            
            // Save to local storage as backup
            localStorage.setItem('newsBruhGameState', JSON.stringify(gameState));
            
            // Save to database if authenticated
            if (isAuthenticated && currentUser) {
                await supabase
                    .from('profiles')
                    .update({
                        game_state: JSON.stringify(gameState),
                        last_active: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);
                
                // Update leaderboard
                await updateLeaderboard();
            }
        } catch (e) {
            console.warn('Could not save game state:', e);
        }
    }

    // NEW: Database Load Function
    async function loadGame() {
        try {
            // First try to load from database if authenticated
            if (isAuthenticated && currentUser) {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('game_state')
                    .eq('id', currentUser.id)
                    .single();
                
                if (!error && profile?.game_state) {
                    const savedState = JSON.parse(profile.game_state);
                    if (savedState && savedState.version === gameState.version) {
                        gameState = { ...gameState, ...savedState };
                        return;
                    }
                }
            }
            
            // Fallback to local storage
            const saved = localStorage.getItem('newsBruhGameState');
            if (saved) {
                const parsed = JSON.parse(saved);
                
                if (!parsed.version || parsed.version !== gameState.version) {
                    console.log('Migrating save data...');
                    if (parsed.buildings && Array.isArray(parsed.buildings)) {
                        parsed.buildings.forEach((savedBuilding, index) => {
                            if (gameState.buildings[index]) {
                                gameState.buildings[index].count = savedBuilding.count || 0;
                            }
                        });
                    }
                    gameState.news = parsed.news || 0;
                    gameState.bruh = parsed.bruh || 0;
                    gameState.version = gameState.version;
                    
                    gameState.boostProgress = parsed.boostProgress || 0;
                    gameState.isBoostActive = parsed.isBoostActive || false;
                    gameState.boostTimeLeft = parsed.boostTimeLeft || 0;
                    gameState.boostCooldown = parsed.boostCooldown || 0;
                    gameState.boostMultiplier = parsed.boostMultiplier || 1;
                    gameState.lastDepletionTime = parsed.lastDepletionTime || Date.now();
                } else {
                    gameState = parsed;
                }
                
                gameState.news = Math.max(0, Number(gameState.news) || 0);
                gameState.bruh = Math.max(0, Number(gameState.bruh) || 0);
                gameState.boostProgress = Math.max(0, Number(gameState.boostProgress) || 0);
                gameState.boostTimeLeft = Math.max(0, Number(gameState.boostTimeLeft) || 0);
                gameState.boostCooldown = Math.max(0, Number(gameState.boostCooldown) || 0);
                gameState.boostMultiplier = Math.max(1, Number(gameState.boostMultiplier) || 1);
                gameState.lastDepletionTime = gameState.lastDepletionTime || Date.now();
            }
        } catch (e) {
            console.warn('Could not load saved game:', e);
        }
    }

    // NEW: Online Chat Functions
    async function sendChatMessage() {
        if (!isAuthenticated) {
            alert('Please login to send messages');
            return;
        }
        
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message || message.length === 0) return;
        
        if (message.length > 200) {
            alert('Message too long (max 200 characters)');
            return;
        }
        
        const chatMessage = {
            sender_id: currentUser.id,
            sender_name: gameState.playerName,
            content: message,
            created_at: new Date().toISOString()
        };
        
        try {
            const { error } = await supabase
                .from('chat_messages')
                .insert([chatMessage]);
            
            if (error) throw error;
            
            input.value = '';
            
            // Reload chat messages
            loadChatMessages();
            
        } catch (error) {
            console.error('Failed to send message:', error);
            alert('Failed to send message. Please try again.');
        }
    }

    async function loadChatMessages() {
        try {
            const { data: messages, error } = await supabase
                .from('chat_messages')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            
            chatMessages = messages || [];
            updateChatDisplay();
            
        } catch (error) {
            console.error('Failed to load chat messages:', error);
        }
    }

    // NEW: Online Leaderboard Functions
    async function updateLeaderboard() {
        if (!isAuthenticated) return;
        
        try {
            // Update player's data
            await supabase
                .from('profiles')
                .update({
                    bruh_count: gameState.bruh,
                    news_count: gameState.news,
                    player_level: calculateLevel(gameState.bruh, gameState.news),
                    last_active: new Date().toISOString()
                })
                .eq('id', currentUser.id);
            
            // Load leaderboard
            loadLeaderboard();
            
        } catch (error) {
            console.error('Failed to update leaderboard:', error);
        }
    }

    async function loadLeaderboard() {
        try {
            const { data: players, error } = await supabase
                .from('profiles')
                .select('username, bruh_count, news_count, player_level, last_active')
                .order('bruh_count', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            
            leaderboardData = (players || []).map((player, index) => ({
                rank: index + 1,
                name: player.username,
                bruh: player.bruh_count || 0,
                news: player.news_count || 0,
                level: player.player_level || 0,
                lastActive: player.last_active,
                formattedBruh: formatNumber(player.bruh_count || 0),
                formattedLevel: formatNumber(player.player_level || 0)
            }));
            
            updateLeaderboardDisplay();
            
        } catch (error) {
            console.error('Failed to load leaderboard:', error);
        }
    }

    async function loadOnlinePlayers() {
        try {
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
            
            const { data: players, error } = await supabase
                .from('profiles')
                .select('username, bruh_count')
                .gte('last_active', fiveMinutesAgo)
                .order('bruh_count', { ascending: false })
                .limit(20);
            
            if (error) throw error;
            
            onlinePlayers = players || [];
            updateOnlinePlayersDisplay();
            
        } catch (error) {
            console.error('Failed to load online players:', error);
        }
    }

    // Original Game Functions (unchanged)
    function manualClick(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const amount = 1 * getMultiplier();
        gameState.news += amount;
        
        incrementBoostProgress();
        
        if (gameState.isBoostActive) {
            resetBoostTimer();
        }
        
        const btn = document.getElementById('print-btn');
        btn.classList.add('pulse');
        setTimeout(() => btn.classList.remove('pulse'), 300);
        
        const floater = document.createElement('div');
        floater.className = 'floater';
        floater.innerText = `ðŸ“° +${formatNumber(amount)}`;
        
        let x, y;
        if (e.type === 'touchstart' || e.type === 'touchmove') {
            const touch = e.touches[0] || e.changedTouches[0];
            x = touch.clientX;
            y = touch.clientY;
        } else {
            x = e.clientX;
            y = e.clientY;
        }
        
        floater.style.left = `${x}px`;
        floater.style.top = `${y}px`;
        document.body.appendChild(floater);
        
        setTimeout(() => floater.remove(), 1000);
        updateUI();
        saveGame();
    }

    function buyMax(id) {
        const building = gameState.buildings[id];
        let bought = 0;
        const maxIterations = 1000;
        
        for (let i = 0; i < maxIterations; i++) {
            let cost = getCost(building);
            if (gameState.news >= cost) {
                gameState.news -= cost;
                building.count++;
                bought++;
            } else {
                break;
            }
        }
        
        if (bought > 0) {
            const card = document.getElementById(`card-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            
            card.style.transform = 'scale(1.02)';
            card.style.backgroundColor = '#e8f5e8';
            card.classList.add('purchased');
            
            setTimeout(() => {
                card.style.transform = '';
                card.style.backgroundColor = '';
            }, 300);
            
            updateUI();
            saveGame();
        }
    }

    function prestige() {
        let bruhsToBuy = 0;
        let tempNews = gameState.news;
        let tempBruh = gameState.bruh;
        let totalCost = 0;
        
        while (true) {
            const nextCost = getPrestigeCost(tempBruh);
            if (tempNews >= nextCost) {
                bruhsToBuy++;
                tempNews -= nextCost;
                tempBruh++;
                totalCost += nextCost;
            } else {
                break;
            }
            if (bruhsToBuy >= 100) break;
        }
        
        if (bruhsToBuy === 0) {
            return;
        }
        
        if (!confirm(`Are you sure? You will lose all News and Assets, but gain ${bruhsToBuy} Bruh${bruhsToBuy > 1 ? 's' : ''} (permanent +${bruhsToBuy * 100}% multiplier).\n\nCurrent Bruh: ${gameState.bruh}\nNew Bruh: ${gameState.bruh + bruhsToBuy}\nTotal Multiplier: x${1 + (gameState.bruh + bruhsToBuy)}`)) {
            return;
        }
        
        gameState.news -= totalCost;
        gameState.bruh += bruhsToBuy;
        
        gameState.buildings.forEach(b => b.count = 0);
        
        gameState.boostProgress = 0;
        gameState.isBoostActive = false;
        gameState.boostTimeLeft = 0;
        gameState.boostCooldown = 0;
        gameState.boostMultiplier = 1;
        gameState.lastDepletionTime = Date.now();
        
        const banner = document.getElementById('breaking-news-banner');
        banner.style.display = 'none';
        
        stopEmojiRain();
        
        if (boostTimerInterval) {
            clearInterval(boostTimerInterval);
            boostTimerInterval = null;
        }
        
        const prestigeBox = document.querySelector('.prestige-box');
        prestigeBox.style.backgroundColor = '#ffe6e6';
        prestigeBox.style.transform = 'scale(1.05)';
        
        setTimeout(() => {
            prestigeBox.style.backgroundColor = '';
            prestigeBox.style.transform = '';
        }, 500);
        
        updateUI();
        updateBoostProgress();
        saveGame();
    }

    function updateUI() {
        document.getElementById('currency').textContent = formatNumber(gameState.news);
        document.getElementById('cps').textContent = formatNumber(getCPS());
        
        if (gameState.isBoostActive) {
            document.getElementById('multiplier').textContent = formatNumber(getMultiplier()) + ' (5x BOOST!)';
            document.getElementById('multiplier').style.color = '#ff0000';
            document.getElementById('multiplier').style.textShadow = '0 0 10px rgba(255, 0, 0, 0.5)';
        } else {
            document.getElementById('multiplier').textContent = formatNumber(getMultiplier());
            document.getElementById('multiplier').style.color = 'var(--red-accent)';
            document.getElementById('multiplier').style.textShadow = 'none';
        }
        
        document.getElementById('bruh-owned').textContent = formatNumber(gameState.bruh);
        document.getElementById('tap-value-display').textContent = `ðŸ“° +${formatNumber(1 * getMultiplier())} New per Tap`;

        const pBtn = document.getElementById('prestige-btn');
        const prestigeCost = getPrestigeCost(gameState.bruh);
        const prestigeCostElement = document.getElementById('prestige-cost');
        const prestigeMaxElement = document.getElementById('prestige-max');
        
        prestigeCostElement.textContent = `Costs: ${formatNumber(prestigeCost)} New`;
        
        let maxBuy = 0;
        let tempNews = gameState.news;
        let tempBruh = gameState.bruh;
        
        while (true) {
            const nextCost = getPrestigeCost(tempBruh);
            if (tempNews >= nextCost) {
                tempNews -= nextCost;
                tempBruh++;
                maxBuy++;
            } else {
                break;
            }
            if (maxBuy >= 100) break;
        }
        
        prestigeMaxElement.textContent = `Max: ${maxBuy}`;
        
        if (maxBuy > 0) {
            pBtn.disabled = false;
            pBtn.innerHTML = `BUY ${maxBuy} BRUH${maxBuy > 1 ? 'S' : ''} (RESET) <div id="prestige-cost" class="prestige-cost">Costs: ${formatNumber(prestigeCost)} New</div> <div id="prestige-max" class="prestige-max">Max: ${maxBuy}</div>`;
        } else {
            pBtn.disabled = true;
            pBtn.innerHTML = `Need ${formatNumber(prestigeCost)} New <div id="prestige-cost" class="prestige-cost">Costs: ${formatNumber(prestigeCost)} New</div> <div id="prestige-max" class="prestige-max">Max: 0</div>`;
        }

        gameState.buildings.forEach(building => {
            const currentCost = getCost(building);
            const maxBuy = getMaxBuy(building);
            const card = document.getElementById(`card-${building.id}`);
            const btn = document.getElementById(`btn-${building.id}`);
            
            if (card) {
                document.getElementById(`count-${building.id}`).textContent = formatNumber(building.count);
                document.getElementById(`cost-text-${building.id}`).textContent = `Cost: ${formatNumber(currentCost)}`;
                
                if (building.count > 0) {
                    card.classList.add('purchased');
                } else {
                    card.classList.remove('purchased');
                }
                
                if (maxBuy > 0) {
                    card.classList.remove('disabled');
                    card.classList.add('affordable');
                    btn.disabled = false;
                    btn.classList.add('affordable');
                    document.getElementById(`max-text-${building.id}`).textContent = `Buy ${maxBuy}`;
                    document.getElementById(`max-text-${building.id}`).style.color = "var(--green-accent)";
                } else {
                    card.classList.remove('affordable');
                    card.classList.add('disabled');
                    btn.disabled = true;
                    btn.classList.remove('affordable');
                    document.getElementById(`max-text-${building.id}`).textContent = "Too Expensive";
                    document.getElementById(`max-text-${building.id}`).style.color = "#666";
                }
            }
        });
        
        // Update player rank if available
        if (leaderboardData.length > 0) {
            const playerRank = leaderboardData.findIndex(p => p.name === gameState.playerName);
            if (playerRank !== -1) {
                document.getElementById('player-rank').textContent = `#${playerRank + 1}`;
            }
        }
    }

    function updateChatDisplay() {
        const chatContainer = document.getElementById('chat-messages');
        if (!chatContainer) return;
        
        chatContainer.innerHTML = '';
        
        [...chatMessages].reverse().forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${msg.sender_name === gameState.playerName ? 'self' : 'other'}`;
            
            if (msg.content.includes(`@${gameState.playerName}`) && msg.sender_name !== gameState.playerName) {
                messageDiv.classList.add('tagged');
            }
            
            const timestamp = new Date(msg.created_at);
            const timeStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let content = msg.content;
            content = content.replace(/@(\w+)/g, '<span class="tagged-player">@$1</span>');
            
            messageDiv.innerHTML = `
                <div class="message-sender">${msg.sender_name} <span class="message-timestamp">${timeStr}</span></div>
                <div class="message-content">${content}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
        });
        
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function updateLeaderboardDisplay() {
        const tbody = document.getElementById('leaderboard-body');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const updateTimeElement = document.getElementById('leaderboard-update-time');
        if (updateTimeElement) {
            updateTimeElement.textContent = `Updated: ${timeStr}`;
        }
        
        const displayCount = Math.min(20, leaderboardData.length);
        
        for (let i = 0; i < displayCount; i++) {
            const player = leaderboardData[i];
            const row = document.createElement('tr');
            
            if (player.name === gameState.playerName) {
                row.style.backgroundColor = '#e8f5e8';
                row.style.fontWeight = 'bold';
            }
            
            let rankClass = '';
            if (player.rank === 1) rankClass = 'rank-1';
            else if (player.rank === 2) rankClass = 'rank-2';
            else if (player.rank === 3) rankClass = 'rank-3';
            
            row.innerHTML = `
                <td class="player-rank ${rankClass}">${player.rank}</td>
                <td class="player-name">${player.name} ${player.name === gameState.playerName ? ' (You)' : ''}</td>
                <td class="player-bruh">${player.formattedBruh}</td>
                <td class="player-level">${player.formattedLevel}</td>
            `;
            
            tbody.appendChild(row);
        }
        
        const currentPlayerIndex = leaderboardData.findIndex(p => p.name === gameState.playerName);
        if (currentPlayerIndex >= 20 && currentPlayerIndex !== -1) {
            const player = leaderboardData[currentPlayerIndex];
            const row = document.createElement('tr');
            row.style.backgroundColor = '#e8f5e8';
            row.style.fontWeight = 'bold';
            
            row.innerHTML = `
                <td class="player-rank">${player.rank}</td>
                <td class="player-name">${player.name} (You)</td>
                <td class="player-bruh">${player.formattedBruh}</td>
                <td class="player-level">${player.formattedLevel}</td>
            `;
            
            tbody.appendChild(row);
        }
    }

    function updateOnlinePlayersDisplay() {
        document.getElementById('online-users-count').textContent = onlinePlayers.length;
        
        const onlineUsersContainer = document.getElementById('online-users');
        if (onlineUsersContainer) {
            onlineUsersContainer.innerHTML = '';
            
            onlinePlayers.forEach(player => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                
                userDiv.innerHTML = `
                    <div>
                        <span class="user-online"></span>
                        <span class="user-name">${player.username}</span>
                    </div>
                    <div class="user-bruh">${formatNumber(player.bruh_count || 0)} Bruh</div>
                `;
                
                onlineUsersContainer.appendChild(userDiv);
            });
        }
    }

    function initGame() {
        if (isInitialized) return;
        
        loadGame();
        
        startDateTimeUpdate();
        
        const container = document.getElementById('upgrades-list');
        container.innerHTML = '';
        
        gameState.buildings.forEach(building => {
            const div = document.createElement('div');
            div.className = 'upgrade-card';
            div.id = `card-${building.id}`;
            
            div.innerHTML = `
                <div class="upgrade-top">
                    <span class="upgrade-name">${building.name}</span>
                    <span class="upgrade-count" id="count-${building.id}">0</span>
                </div>
                <div class="upgrade-info">
                    +${building.baseCPS} CPS (Base)
                </div>
                <button class="upgrade-btn" id="btn-${building.id}" onclick="buyMax(${building.id})">
                    <div class="upgrade-cost" id="cost-text-${building.id}">Cost: 0</div>
                    <div class="upgrade-max" id="max-text-${building.id}">Max: 0</div>
                </button>
            `;
            
            container.appendChild(div);
        });
        
        const printBtn = document.getElementById('print-btn');
        
        printBtn.addEventListener('mousedown', manualClick);
        
        printBtn.addEventListener('touchstart', function(e) {
            manualClick(e);
        }, { passive: false });
        
        printBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
        }, { passive: false });
        
        const boostButton = document.getElementById('boost-button');
        boostButton.addEventListener('click', function() {});
        
        const chatInput = document.getElementById('chat-input');
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        
        printBtn.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        const now = Date.now();
        const lastUpdate = gameState.lastUpdate || now;
        const timeDiff = (now - lastUpdate) / 1000;
        
        if (timeDiff > 1 && timeDiff < 86400) {
            const offlineEarnings = getCPS() * timeDiff;
            if (offlineEarnings > 0) {
                gameState.news += offlineEarnings;
                console.log(`Offline earnings: ${formatNumber(offlineEarnings)} New (${Math.floor(timeDiff)} seconds)`);
            }
        }
        
        updateUI();
        updateBoostProgress();
        
        if (gameState.isBoostActive) {
            if (boostTimerInterval) clearInterval(boostTimerInterval);
            boostTimerInterval = setInterval(updateBoostTimer, 1000);
            
            const banner = document.getElementById('breaking-news-banner');
            banner.style.display = 'block';
            
            startEmojiRain();
            
            const statBlocks = document.querySelectorAll('.stat-block');
            statBlocks.forEach(block => {
                block.classList.add('active-boost');
            });
        }
        
        if (gameState.boostCooldown > 0) {
            const cooldownInterval = setInterval(() => {
                gameState.boostCooldown--;
                updateBoostProgress();
                
                if (gameState.boostCooldown <= 0) {
                    clearInterval(cooldownInterval);
                    gameState.boostCooldown = 0;
                    updateBoostProgress();
                }
            }, 1000);
        }
        
        if (isAuthenticated) {
            loadChatMessages();
            loadLeaderboard();
            loadOnlinePlayers();
        }
        
        updateChatDisplay();
        
        isInitialized = true;
        
        startGameLoops();
    }

    function startGameLoops() {
        function updateNews() {
            const cps = getCPS();
            if (cps > 0) {
                gameState.news += cps * 0.1;
                if (gameState.news < 0) gameState.news = 0;
                if (gameState.news > Number.MAX_SAFE_INTEGER) {
                    gameState.news = Number.MAX_SAFE_INTEGER;
                }
            }
        }

        function gameLoop() {
            updateNews();
            depleteBoostProgress();
            updateUI();
            requestAnimationFrame(gameLoop);
        }

        function rotateHeadlines() {
            const headlines = [
                "Local cat appointed Editor-in-Chief.",
                "Ink shortage causes panic; citizens using pencil.",
                "Bruh currency value skyrockets over speculation.",
                "Paperboys unionize, demand faster bicycles.",
                "Breaking: Nothing happened today.",
                "Weather forecast: Cloudy with a chance of News.",
                "Typo in front page headline causes minor confusion.",
                "Printing press inventor wins Nobel Prize.",
                "Newspaper sales reach all-time high.",
                "Digital media fails to replace traditional print.",
                "Bruh consultants in high demand worldwide.",
                "Newspaper subscription rates double overnight.",
                "Local economy booms thanks to printing industry.",
                "Ink suppliers report record profits.",
                "Breaking: News consumption at all-time high.",
                "New infinite number system baffles mathematicians.",
                "Alphabetical scaling revolutionizes finance.",
                "Numbers grow beyond traditional notation.",
                "From k to z to aa: The new math frontier.",
                "Infinity now has a proper naming convention.",
                "Online edition launches with multiplayer features!",
                "Players worldwide competing for top leaderboard spots.",
                "Real-time chat connects global newspaper tycoons.",
                "Email recovery system implemented for account security."
            ];
            
            const randomHeadline = headlines[Math.floor(Math.random() * headlines.length)];
            const el = document.getElementById('headline-spot');
            
            el.style.opacity = 0;
            setTimeout(() => {
                el.textContent = `"${randomHeadline}"`;
                el.style.opacity = 1;
            }, 500);
        }

        function autoSave() {
            saveGame();
        }

        function updateLeaderboardPeriodically() {
            if (isAuthenticated) {
                const now = Date.now();
                if (now - lastLeaderboardUpdate > 30000) { // Every 30 seconds
                    loadLeaderboard();
                    lastLeaderboardUpdate = now;
                }
            }
        }

        function updateChatPeriodically() {
            if (isAuthenticated) {
                const now = Date.now();
                if (now - lastChatUpdate > 10000) { // Every 10 seconds
                    loadChatMessages();
                    loadOnlinePlayers();
                    lastChatUpdate = now;
                }
            }
        }

        gameLoop();
        setInterval(rotateHeadlines, 10000);
        setInterval(autoSave, 30000);
        
        if (isAuthenticated) {
            setInterval(updateLeaderboardPeriodically, 5000);
            setInterval(updateChatPeriodically, 10000);
        }
        
        setInterval(() => {
            const online = document.getElementById('online-count');
            const total = document.getElementById('total-count');
            
            const onlineChange = Math.floor(Math.random() * 100) - 50;
            const totalChange = Math.floor(Math.random() * 1000);
            
            let currentOnline = parseInt(online.textContent.replace(/,/g, '')) || 12403;
            let currentTotal = parseInt(total.textContent.replace(/,/g, '')) || 842019;
            
            currentOnline = Math.max(10000, currentOnline + onlineChange);
            currentTotal = Math.max(842000, currentTotal + totalChange);
            
            online.textContent = currentOnline.toLocaleString();
            total.textContent = currentTotal.toLocaleString();
        }, 30000);
    }

    // Hard Reset Functions (keep original)
    function showResetConfirmation() {
        document.getElementById('reset-current-bruh').textContent = formatNumber(gameState.bruh);
        document.getElementById('reset-current-news').textContent = formatNumber(gameState.news);
        
        const totalBuildings = gameState.buildings.reduce((sum, b) => sum + b.count, 0);
        document.getElementById('reset-buildings-count').textContent = formatNumber(totalBuildings);
        
        document.getElementById('reset-chat-count').textContent = chatMessages.length;
        
        document.getElementById('reset-confirmation-modal').style.display = 'flex';
        
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.1);
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime + 0.2);
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.3);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } catch (e) {}
    }

    function hideResetConfirmation() {
        document.getElementById('reset-confirmation-modal').style.display = 'none';
    }

    async function performHardReset() {
        if (isAuthenticated && currentUser) {
            // Reset game state in database
            await supabase
                .from('profiles')
                .update({
                    game_state: JSON.stringify(defaultGameState),
                    bruh_count: 0,
                    news_count: 0,
                    player_level: 0
                })
                .eq('id', currentUser.id);
        }
        
        localStorage.removeItem('newsBruhGameState');
        sessionStorage.clear();
        
        gameState = JSON.parse(JSON.stringify(defaultGameState));
        
        hideResetConfirmation();
        
        const resetBox = document.querySelector('.reset-confirmation-box');
        const originalContent = resetBox.innerHTML;
        
        resetBox.innerHTML = `
            <span style="font-size: 3rem; color: #4CAF50;">âœ“</span>
            <h3 style="color: #4CAF50;">RESET COMPLETE!</h3>
            <p>All game progress has been reset. Your account remains active.</p>
            <div style="margin-top: 20px; font-family: var(--font-mono);">
                <strong>Game has been reset to beginning!</strong><br>
            </div>
        `;
        
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } catch (e) {}
        
        setTimeout(() => {
            location.reload();
        }, 2000);
    }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', async () => {
        // Check authentication status
        await checkAuth();
        
        // Listen for auth changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                checkAuth();
            } else if (event === 'SIGNED_OUT') {
                location.reload();
            }
        });
    });
    
    window.addEventListener('beforeunload', saveGame);
    
    // Add event listeners for reset modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideResetConfirmation();
        }
    });

    document.getElementById('reset-confirmation-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideResetConfirmation();
        }
    });
    
    // Export functions to global scope
    window.manualClick = manualClick;
    window.buyMax = buyMax;
    window.prestige = prestige;
    window.sendChatMessage = sendChatMessage;
    window.showResetConfirmation = showResetConfirmation;
    window.hideResetConfirmation = hideResetConfirmation;
    window.performHardReset = performHardReset;
    window.formatNumber = formatNumber;
    window.switchAuthTab = switchAuthTab;
    window.register = register;
    window.login = login;
    window.resetPassword = resetPassword;
    window.logout = logout;
</script>
</body>
</html>
